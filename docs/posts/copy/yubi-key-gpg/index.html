<!DOCTYPE html>
<html lang="en" style="
     --accent-color:#fc50f6 ;
     --bg-color:#080a0f ;
     --fg-color:#c4d0d1 ;
    ;
    ">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script type="text/javascript">
        var randomColor = "#"+((1<<24)*Math.random()|0).toString(16);
        <!-- document.documentElement.style.setProperty('--glitch-color', randomColor); -->
    </script>

    <meta name="author" content="Trim Bresilla">
    <meta name="description" content="Personal website &amp; bolg">
    <meta name="keywords" content="blog,developer,personal">

    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Guide to using YubiKey for GPG and SSH"/>
<meta name="twitter:description" content="This is a guide to using YubiKey as a SmartCard for storing GPG encryption, signing and authentication keys, which can also be used for SSH. Many of the principles in this document are applicable to other smart card devices.
Keys stored on YubiKey are non-exportable (as opposed to file-based keys that are stored on disk) and are convenient for everyday use. Instead of having to remember and enter passphrases to unlock SSH/GPG keys, YubiKey needs only a physical touch after being unlocked with a PIN."/>

    <meta property="og:title" content="Guide to using YubiKey for GPG and SSH" />
<meta property="og:description" content="This is a guide to using YubiKey as a SmartCard for storing GPG encryption, signing and authentication keys, which can also be used for SSH. Many of the principles in this document are applicable to other smart card devices.
Keys stored on YubiKey are non-exportable (as opposed to file-based keys that are stored on disk) and are convenient for everyday use. Instead of having to remember and enter passphrases to unlock SSH/GPG keys, YubiKey needs only a physical touch after being unlocked with a PIN." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/copy/yubi-key-gpg/" />
<meta property="article:published_time" content="2020-01-04T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-01-04T00:00:00+00:00" />



    
      <base href="/posts/copy/yubi-key-gpg/">
    
    <title>
    Guide to using YubiKey for GPG and SSH Â· bresilla
</title>

    
      <link rel="canonical" href="/posts/copy/yubi-key-gpg/">
    

    <link href="https://fonts.googleapis.com/css?family=Lato:400,700%7CMerriweather:300,700%7CSource+Code+Pro:400,700" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" integrity="sha256-l85OmPOjvil/SOvVt3HnSSjzF1TUMyT9eV0c2BzEGzU=" crossorigin="anonymous" />

    
      
      
      <link rel="stylesheet" href="/coder/coder.min.e54433c07cbec960ef4350410b4c3772614409106cad9fea9a02137ee532b088.css" integrity="sha256-5UQzwHy&#43;yWDvQ1BBC0w3cmFECRBsrZ/qmgITfuUysIg=" crossorigin="anonymous" media="screen" />
    

    

    

    <link rel="icon" type="image/png" href="/images/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/images/favicon-16x16.png" sizes="16x16">

    <meta name="generator" content="Hugo 0.62.2" />
  </head>
  <body >
        
      <main id="main" class="wrapper yubi-key-gpg">

      <nav class="navigation">
  <section class="container">
      <label class="title">
          <a class="navigation-title" href="/">
              bresilla
          </a>
      </label>
    <input type="checkbox" id="menu-toggle" />
    <label class="menu-button float-right" for="menu-toggle"><i class="fas fa-bars"></i></label>
    <ul class="navigation-list">
      
        
          <li class="navigation-item">
            <a class="navigation-link" href="/about/">about</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="/resume">resume</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="/posts/">blog</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="/talk/">talks</a>
          </li>
        
      
      
    </ul>
  </section>
</nav>


      <div class="content">
        
    <section class="container page estate"  style=" --real-estate:60%; ">
    <article>
        <header>
            
                <h1 class="yubi-key-gpg title glitchtitle"  data-text="Guide to using YubiKey for GPG and SSH" >Guide to using YubiKey for GPG and SSH</h1>
            
            
            
            <div class="undertitle" style="padding-left:2%;" >
                <details class="dropdown" >
                    <summary>
                        <span id="title_part" style="color:var(--bg-color); background-color:var(--accent-color); cursor: pointer; display:inline-block;" >&nbsp;INDEX&nbsp;</span>
                        <span style="color:var(--fg-color)">&nbsp;</span>

                        
                        <span id="title_categories" style="color:var(--accent-color) display:inline-block;" >
                            Category: 
                            
                                
                                
                                    <a href="/categories/copy/" >COPY</a>
                                
                            
                            <span style="color:var(--fg-color)">|</span>
                        </span>
                        
                        <span id="title_tags" style="color:var(--accent-color) display:inline-block;" >
                             Tags: 
                            
                                
                                
                                <a href="/tags/yubikey/" >yubikey</a>
                                
                            
                                
                                
                                <a href="/tags/gpg/" >gpg</a>
                                
                            
                                
                                
                                <a href="/tags/pass/" >pass</a>
                                
                            
                            <span style="color:var(--fg-color)">|</span>
                        </span>

                        
                            <span class="title_posturl" style="color:var(--accent-color) display:inline-block;" >Url: <a href="https://github.com/drduh/YubiKey-Guide" > https://github.com/drduh/YubiKey-Guide </a></span>
                            <span style="color:var(--fg-color)">|</span>
                        

                        
                        <span id="title_series" style="color:var(--accent-color) display:inline-block;" >
                            Series: 
                            
                                
                                
                                <a href="/series/gpg/" >GPG</a>
                                
                            
                            
                        </span>
                    </summary>
                    <nav id="TableOfContents">
  <ul>
    <li><a href="#purchase-yubikey">Purchase YubiKey</a></li>
    <li><a href="#verify-yubikey">Verify YubiKey</a></li>
    <li><a href="#download-os-image">Download OS Image</a></li>
    <li><a href="#required-software">Required software</a>
      <ul>
        <li><a href="#debianubuntu">Debian/Ubuntu</a></li>
        <li><a href="#arch">Arch</a></li>
        <li><a href="#rhel7">RHEL7</a></li>
        <li><a href="#openbsd">OpenBSD</a></li>
        <li><a href="#macos">macOS</a></li>
        <li><a href="#windows">Windows</a></li>
      </ul>
    </li>
    <li><a href="#entropy">Entropy</a></li>
    <li><a href="#creating-keys">Creating keys</a></li>
    <li><a href="#master-key">Master key</a></li>
    <li><a href="#sign-with-an-existing-key-optional">Sign with an existing key (optional)</a></li>
    <li><a href="#sub-keys">Sub-keys</a>
      <ul>
        <li><a href="#signing">Signing</a></li>
        <li><a href="#encryption">Encryption</a></li>
        <li><a href="#authentication">Authentication</a></li>
        <li><a href="#add-extra-emails">Add extra emails</a></li>
      </ul>
    </li>
    <li><a href="#verify">Verify</a></li>
    <li><a href="#export">Export</a></li>
    <li><a href="#backup">Backup</a></li>
    <li><a href="#configure-smartcard">Configure Smartcard</a>
      <ul>
        <li><a href="#change-pin">Change PIN</a></li>
        <li><a href="#set-information">Set information</a></li>
      </ul>
    </li>
    <li><a href="#transfer-keys">Transfer keys</a>
      <ul>
        <li><a href="#signing-1">Signing</a></li>
        <li><a href="#encryption-1">Encryption</a></li>
        <li><a href="#authentication-1">Authentication</a></li>
      </ul>
    </li>
    <li><a href="#verify-card">Verify card</a></li>
    <li><a href="#cleanup">Cleanup</a></li>
    <li><a href="#using-keys">Using keys</a></li>
    <li><a href="#rotating-keys">Rotating keys</a></li>
    <li><a href="#ssh">SSH</a>
      <ul>
        <li><a href="#create-configuration">Create configuration</a></li>
        <li><a href="#replace-agents">Replace agents</a></li>
        <li><a href="#copy-public-key">Copy public key</a></li>
        <li><a href="#optional-save-public-key-for-identity-file-configuration">(Optional) Save public key for identity file configuration</a></li>
        <li><a href="#connect-with-public-key-authentication">Connect with public key authentication</a></li>
        <li><a href="#import-ssh-keys">Import SSH keys</a></li>
        <li><a href="#remote-machines-agent-forwarding">Remote Machines (Agent Forwarding)</a>
          <ul>
            <li><a href="#steps-for-older-distributions">Steps for older distributions</a></li>
          </ul>
        </li>
        <li><a href="#github">GitHub</a></li>
        <li><a href="#openbsd-1">OpenBSD</a></li>
        <li><a href="#windows-1">Windows</a>
          <ul>
            <li><a href="#wsl">WSL</a>
              <ul>
                <li><a href="#prerequisites">Prerequisites</a></li>
                <li><a href="#wsl-configuration">WSL configuration</a></li>
                <li><a href="#remote-host-configuration">Remote host configuration</a></li>
              </ul>
            </li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#multiple-keys">Multiple Keys</a></li>
    <li><a href="#require-touch">Require touch</a></li>
    <li><a href="#email">Email</a>
      <ul>
        <li><a href="#mailvelope-on-macos">Mailvelope on macOS</a></li>
      </ul>
    </li>
    <li><a href="#reset">Reset</a></li>
    <li><a href="#notes">Notes</a></li>
    <li><a href="#troubleshooting">Troubleshooting</a></li>
    <li><a href="#links">Links</a></li>
  </ul>
</nav>
                </details>
            </div>
            
        </header>
        <span class=" blogpost " style=" --titlecolor: var(--accent-color);" >
            <p>This is a guide to using <a href="https://www.yubico.com/products/yubikey-hardware/">YubiKey</a> as a <a href="https://security.stackexchange.com/questions/38924/how-does-storing-gpg-ssh-private-keys-on-smart-cards-compare-to-plain-usb-drives">SmartCard</a> for storing GPG encryption, signing and authentication keys, which can also be used for SSH. Many of the principles in this document are applicable to other smart card devices.</p>
<p>Keys stored on YubiKey are <a href="https://support.yubico.com/support/solutions/articles/15000010242-can-i-duplicate-or-back-up-a-yubikey-">non-exportable</a> (as opposed to file-based keys that are stored on disk) and are convenient for everyday use. Instead of having to remember and enter passphrases to unlock SSH/GPG keys, YubiKey needs only a physical touch after being unlocked with a PIN. All signing and encryption operations happen on the card, rather than in OS memory.</p>
<h1 id="purchase-yubikey">Purchase YubiKey</h1>
<p>All YubiKeys except the blue &ldquo;security key&rdquo; model are compatible with this guide. NEO models are limited to 2048-bit RSA keys. Compare YubiKeys <a href="https://www.yubico.com/products/yubikey-hardware/compare-products-series/">here</a>.</p>
<h1 id="verify-yubikey">Verify YubiKey</h1>
<p>To verify a YubiKey is genuine, open a <a href="https://support.yubico.com/support/solutions/articles/15000009591-how-to-confirm-your-yubico-device-is-genuine-with-u2f">browser with U2F support</a> to <a href="https://www.yubico.com/genuine/">https://www.yubico.com/genuine/</a>. Insert a Yubico device, and select <em>Verify Device</em> to begin the process. Touch the YubiKey when prompted, and if asked, allow it to see the make and model of the device. If you see <em>Verification complete</em>, the device is authentic.</p>
<p>This website verifies the YubiKey's device attestation certificates signed by a set of Yubico CAs, and helps mitigate <a href="https://media.defcon.org/DEF%20CON%2025/DEF%20CON%2025%20presentations/DEF%20CON%2025%20-%20r00killah-and-securelyfitz-Secure-Tokin-and-Doobiekeys.pdf">supply chain attacks</a>.</p>
<h1 id="download-os-image">Download OS Image</h1>
<p>You will need several small storage devices for booting a temporary operating system and creating backups of your private/public keys.</p>
<p>It is recommended to generate cryptographic keys and configure YubiKey from a secure operating system and using an ephemeral environment (&ldquo;live image&rdquo;), such as <a href="https://www.debian.org/CD/live/">Debian</a>, <a href="https://tails.boum.org/index.en.html">Tails</a>, or <a href="https://www.openbsd.org/">OpenBSD</a> booted from a USB drive.</p>
<p>Depending on your threat model and/or level of inherent trust in your own system, it may also be a valid option to run the live image within a virtual machine using <a href="https://virt-manager.org/">virt-manager</a>, VirtualBox, or VMWare software.</p>
<p>To use Debian, download the latest image:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ curl -LfO https://cdimage.debian.org/debian-cd/current-live/amd64/iso-hybrid/debian-live-10.2.0-amd64-xfce.iso

$ curl -LfO https://cdimage.debian.org/debian-cd/current-live/amd64/iso-hybrid/SHA512SUMS

$ curl -LfO https://cdimage.debian.org/debian-cd/current-live/amd64/iso-hybrid/SHA512SUMS.sign
</code></pre></div><p>Verify the signature of the hashes file with GPG:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ gpg --verify SHA512SUMS.sign SHA512SUMS
gpg: Signature made Sat Nov 16 18:49:18 2019 PST
gpg:                using RSA key DF9B9C49EAA9298432589D76DA87E80D6294BE9B
gpg: Can&#39;t check signature: No public key

$ gpg --keyserver hkps://keyring.debian.org --recv DF9B9C49EAA9298432589D76DA87E80D6294BE9B
gpg: key 0xDA87E80D6294BE9B: 5 signatures not checked due to missing keys
gpg: key 0xDA87E80D6294BE9B: public key &#34;Debian CD signing key &lt;debian-cd@lists.debian.org&gt;&#34; imported
gpg: Total number processed: 1
gpg:               imported: 1

$ gpg --verify SHA512SUMS.sign SHA512SUMS
gpg: Signature made Sat Nov 16 18:49:18 2019 PST
gpg:                using RSA key DF9B9C49EAA9298432589D76DA87E80D6294BE9B
gpg: Good signature from &#34;Debian CD signing key &lt;debian-cd@lists.debian.org&gt;&#34; [unknown]
gpg: WARNING: This key is not certified with a trusted signature!
gpg:          There is no indication that the signature belongs to the owner.
Primary key fingerprint: DF9B 9C49 EAA9 2984 3258  9D76 DA87 E80D 6294 BE9B
</code></pre></div><p>If the public key cannot be received, try changing the DNS resolver and/or use a different keyserver:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ gpg --keyserver hkps://keyserver.ubuntu.com:443 --recv DF9B9C49EAA9298432589D76DA87E80D6294BE9B
</code></pre></div><p>Ensure the SHA512 hash of the live image matches the one in the signed file.</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ grep $(sha512sum debian-live-10.2.0-amd64-xfce.iso) SHA512SUMS
SHA512SUMS:b253e347bf04c4e16b4c948b88bfba58f6084717f8ca290d5ea320837f63cf69b46734b7127dabd114ad88022075020982434fcf31463b82c6225671e7116a4d  debian-live-10.2.0-amd64-xfce.iso
</code></pre></div><p>See <a href="https://www.debian.org/CD/verify">Verifying authenticity of Debian CDs</a> for more information.</p>
<p>Mount a storage device and copy the image to it:</p>
<p><strong>Linux</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ sudo dmesg | tail
usb-storage 3-2:1.0: USB Mass Storage device detected
scsi host2: usb-storage 3-2:1.0
scsi 2:0:0:0: Direct-Access     TS-RDF5  SD  Transcend    TS3A PQ: 0 ANSI: 6
sd 2:0:0:0: Attached scsi generic sg1 type 0
sd 2:0:0:0: [sdb] 31116288 512-byte logical blocks: (15.9 GB/14.8 GiB)
sd 2:0:0:0: [sdb] Write Protect is off
sd 2:0:0:0: [sdb] Mode Sense: 23 00 00 00
sd 2:0:0:0: [sdb] Write cache: disabled, read cache: enabled, doesn&#39;t support DPO or FUA
sdb: sdb1 sdb2
sd 2:0:0:0: [sdb] Attached SCSI removable disk

$ sudo dd if=debian-live-10.2.0-amd64-xfce.iso of=/dev/sdb bs=4M; sync
465+1 records in
465+1 records out
1951432704 bytes (2.0 GB, 1.8 GiB) copied, 42.8543 s, 45.5 MB/s
</code></pre></div><p><strong>OpenBSD</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ dmesg | tail -n2
sd2 at scsibus4 targ 1 lun 0: &lt;TS-RDF5, SD Transcend, TS3A&gt; SCSI4 0/direct removable serial.0000000000000
sd2: 15193MB, 512 bytes/sector, 31116288 sectors

$ doas dd if=debian-live-10.2.0-amd64-xfce.iso of=/dev/rsd2c bs=4m
465+1 records in
465+1 records out
1951432704 bytes transferred in 139.125 secs (14026448 bytes/sec)
</code></pre></div><p>Shut down the computer and disconnect internal hard drives and all unnecessary peripheral devices. If being run within a VM, this part can be skipped as no such devices should be attached to the VM since the image will still be run as a &ldquo;live image&rdquo;.</p>
<p>If on physical hardware consider using secure hardware like a ThinkPad X230 running <a href="https://www.coreboot.org/">Coreboot</a> and <a href="https://github.com/corna/me_cleaner">cleaned of Intel ME</a>.</p>
<h1 id="required-software">Required software</h1>
<p>Boot the live image and configure networking.</p>
<p><strong>Note</strong> If the screen locks, unlock with <code>user</code>/<code>live</code>.</p>
<p>Open the terminal and install required software packages.</p>
<h2 id="debianubuntu">Debian/Ubuntu</h2>
<p><strong>Note</strong> Live Ubuntu images <a href="https://github.com/drduh/YubiKey-Guide/issues/116">may require modification</a> to <code>/etc/apt/sources.list</code></p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ sudo apt update

$ sudo apt install -y wget gnupg2 gnupg-agent dirmngr cryptsetup scdaemon pcscd secure-delete hopenpgp-tools yubikey-personalization
</code></pre></div><h2 id="arch">Arch</h2>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ sudo pacman -Syu gnupg2 pcsclite ccid hopenpgp-tools yubikey-personalization
</code></pre></div><h2 id="rhel7">RHEL7</h2>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ sudo yum install -y gnupg2 pinentry-curses pcsc-lite pcsc-lite-libs gnupg2-smime
</code></pre></div><h2 id="openbsd">OpenBSD</h2>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ doas pkg_add gnupg pcsc-tools
</code></pre></div><h2 id="macos">macOS</h2>
<p>Download and install <a href="https://brew.sh/">Homebrew</a> and the following packages:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ brew install gnupg yubikey-personalization hopenpgp-tools ykman pinentry-mac
</code></pre></div><p><strong>Note</strong> An additional Python package dependency may need to be installed to use <a href="https://support.yubico.com/support/solutions/articles/15000012643-yubikey-manager-cli-ykman-user-guide"><code>ykman</code></a> - <code>pip install yubikey-manager</code></p>
<h2 id="windows">Windows</h2>
<p>Download and install <a href="https://www.gpg4win.org/">Gpg4Win</a> and <a href="https://putty.org">PuTTY</a>.</p>
<p>You may also need more recent versions of <a href="https://developers.yubico.com/yubikey-personalization/Releases/">yubikey-personalization</a> and <a href="https://developers.yubico.com/yubico-c/Releases/">yubico-c</a>.</p>
<h1 id="entropy">Entropy</h1>
<p>Generating cryptographic keys requires high-quality <a href="https://www.random.org/randomness/">randomness</a>, measured as entropy.</p>
<p>To check the available entropy available on Linux:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ cat /proc/sys/kernel/random/entropy_avail
849
</code></pre></div><p>Most operating systems use software-based pseudorandom number generators. A hardware random number generator like <a href="https://onerng.info/onerng/">OneRNG</a> will <a href="https://lwn.net/Articles/648550/">increase the speed</a> of entropy generation and possibly the quality.</p>
<p>Install and configure OneRNG software:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ sudo apt install -y at rng-tools python-gnupg openssl

$ wget https://github.com/OneRNG/onerng.github.io/raw/master/sw/onerng_3.6-1_all.deb

$ sha256sum onerng_3.6-1_all.deb
a9ccf7b04ee317dbfc91518542301e2d60ebe205d38e80563f29aac7cd845ccb  onerng_3.6-1_all.deb

$ sudo dpkg -i onerng_3.6-1_all.deb

$ echo &#34;HRNGDEVICE=/dev/ttyACM0&#34; | sudo tee /etc/default/rng-tools
</code></pre></div><p>Plug in the device and restart rng-tools:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ sudo atd

$ sudo service rng-tools restart
</code></pre></div><p>Test by emptying <code>/dev/random</code> - the light on the device will dim briefly:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ cat /dev/random &gt;/dev/null
[Press Control-C]
</code></pre></div><p>After a few seconds, verify the available entropy pool is quickly re-seeded:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ cat /proc/sys/kernel/random/entropy_avail
3049
</code></pre></div><p>An entropy pool value greater than 2000 is sufficient.</p>
<h1 id="creating-keys">Creating keys</h1>
<p>Create a temporary directory which will be cleared on <a href="https://en.wikipedia.org/wiki/Tmpfs">reboot</a>:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ export GNUPGHOME=$(mktemp -d)

$ cd $GNUPGHOME
</code></pre></div><p>Create a hardened configuration in the temporary directory with the following options:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ wget https://raw.githubusercontent.com/drduh/config/master/gpg.conf

$ grep -ve &#34;^#&#34; $GNUPGHOME/gpg.conf
personal-cipher-preferences AES256 AES192 AES
personal-digest-preferences SHA512 SHA384 SHA256
personal-compress-preferences ZLIB BZIP2 ZIP Uncompressed
default-preference-list SHA512 SHA384 SHA256 AES256 AES192 AES ZLIB BZIP2 ZIP Uncompressed
cert-digest-algo SHA512
s2k-digest-algo SHA512
s2k-cipher-algo AES256
charset utf-8
fixed-list-mode
no-comments
no-emit-version
keyid-format 0xlong
list-options show-uid-validity
verify-options show-uid-validity
with-fingerprint
require-cross-certification
no-symkey-cache
throw-keyids
use-agent
</code></pre></div><p>Disable networking for the remainder of the setup.</p>
<h1 id="master-key">Master key</h1>
<p>The first key to generate is the master key. It will be used for certification only: to issue sub-keys that are used for encryption, signing and authentication.</p>
<p><strong>Important</strong> The master key should be kept offline at all times and only accessed to revoke or issue new sub-keys. Keys can also be generated on the YubiKey itself to ensure no other copies exist.</p>
<p>You'll be prompted to enter and verify a passphrase - keep it handy as you'll need it multiple times later.</p>
<p>To generate a strong passphrase which could be written down in a hidden or secure place; or memorized:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ gpg --gen-random --armor 0 24
ydOmByxmDe63u7gqx2XI9eDgpvJwibNH
</code></pre></div><p>On Linux or OpenBSD, select the password with the mouse to copy it to the clipboard and paste using the middle mouse button or <code>Shift</code>-<code>Insert</code>.</p>
<p>Generate a new key with GPG, selecting <code>(8) RSA (set your own capabilities)</code>, <code>Certify</code> capability only and <code>4096</code> bit key size.</p>
<p>Do not set the master key to expire - see <a href="#notes">Note #3</a>.</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ gpg --expert --full-generate-key

Please select what kind of key you want:
   (1) RSA and RSA (default)
   (2) DSA and Elgamal
   (3) DSA (sign only)
   (4) RSA (sign only)
   (7) DSA (set your own capabilities)
   (8) RSA (set your own capabilities)
   (9) ECC and ECC
  (10) ECC (sign only)
  (11) ECC (set your own capabilities)
  (13) Existing key
Your selection? 8

Possible actions for a RSA key: Sign Certify Encrypt Authenticate
Current allowed actions: Sign Certify Encrypt

   (S) Toggle the sign capability
   (E) Toggle the encrypt capability
   (A) Toggle the authenticate capability
   (Q) Finished

Your selection? E

Possible actions for a RSA key: Sign Certify Encrypt Authenticate
Current allowed actions: Sign Certify

   (S) Toggle the sign capability
   (E) Toggle the encrypt capability
   (A) Toggle the authenticate capability
   (Q) Finished

Your selection? S

Possible actions for a RSA key: Sign Certify Encrypt Authenticate
Current allowed actions: Certify

   (S) Toggle the sign capability
   (E) Toggle the encrypt capability
   (A) Toggle the authenticate capability
   (Q) Finished

Your selection? Q
RSA keys may be between 1024 and 4096 bits long.
What keysize do you want? (2048) 4096
Requested keysize is 4096 bits
Please specify how long the key should be valid.
         0 = key does not expire
      &lt;n&gt;  = key expires in n days
      &lt;n&gt;w = key expires in n weeks
      &lt;n&gt;m = key expires in n months
      &lt;n&gt;y = key expires in n years
Key is valid for? (0) 0
Key does not expire at all
Is this correct? (y/N) y
</code></pre></div><p>Select a name and email address - neither has to be valid nor existing.</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">GnuPG needs to construct a user ID to identify your key.

Real name: Dr Duh
Email address: doc@duh.to
Comment: [Optional - leave blank]
You selected this USER-ID:
    &#34;Dr Duh &lt;doc@duh.to&gt;&#34;

Change (N)ame, (C)omment, (E)mail or (O)kay/(Q)uit? o

We need to generate a lot of random bytes. It is a good idea to perform
some other action (type on the keyboard, move the mouse, utilize the
disks) during the prime generation; this gives the random number
generator a better chance to gain enough entropy.

gpg: /tmp.FLZC0xcM/trustdb.gpg: trustdb created
gpg: key 0xFF3E7D88647EBCDB marked as ultimately trusted
gpg: directory &#39;/tmp.FLZC0xcM/openpgp-revocs.d&#39; created
gpg: revocation certificate stored as &#39;/tmp.FLZC0xcM/openpgp-revocs.d/011CE16BD45B27A55BA8776DFF3E7D88647EBCDB.rev&#39;
public and secret key created and signed.

pub   rsa4096/0xFF3E7D88647EBCDB 2017-10-09 [C]
      Key fingerprint = 011C E16B D45B 27A5 5BA8  776D FF3E 7D88 647E BCDB
uid                              Dr Duh &lt;doc@duh.to&gt;
</code></pre></div><p>Export the key ID as a <a href="https://stackoverflow.com/questions/1158091/defining-a-variable-with-or-without-export/1158231#1158231">variable</a> (<code>KEYID</code>) for use later:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ export KEYID=0xFF3E7D88647EBCDB
</code></pre></div><h1 id="sign-with-an-existing-key-optional">Sign with an existing key (optional)</h1>
<p>If you already have a PGP key, you may want to sign the new key with the old one to prove that the new key is controlled by you.</p>
<p>Export your existing key to move it to the working keyring:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ gpg --export-secret-keys --armor --output /tmp/new.sec
</code></pre></div><p>Then sign the new key:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ gpg  --default-key $OLDKEY --sign-key $KEYID
</code></pre></div><h1 id="sub-keys">Sub-keys</h1>
<p>Edit the master key to add sub-keys:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ gpg --expert --edit-key $KEYID

Secret key is available.

sec  rsa4096/0xEA5DE91459B80592
    created: 2017-10-09  expires: never       usage: C
    trust: ultimate      validity: ultimate
[ultimate] (1). Dr Duh &lt;doc@duh.to&gt;
</code></pre></div><p>Use 4096-bit RSA keys.</p>
<p>Use a 1 year expiration for sub-keys - they can be renewed using the offline master key. See <a href="#rotating-keys">rotating keys</a>.</p>
<h2 id="signing">Signing</h2>
<p>Create a <a href="https://stackoverflow.com/questions/5421107/can-rsa-be-both-used-as-encryption-and-signature/5432623#5432623">signing key</a> by selecting <code>(4) RSA (sign only)</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">gpg&gt; addkey
Key is protected.

You need a passphrase to unlock the secret key for
user: &#34;Dr Duh &lt;doc@duh.to&gt;&#34;
4096-bit RSA key, ID 0xFF3E7D88647EBCDB, created 2016-05-24

Please select what kind of key you want:
   (3) DSA (sign only)
   (4) RSA (sign only)
   (5) Elgamal (encrypt only)
   (6) RSA (encrypt only)
   (7) DSA (set your own capabilities)
   (8) RSA (set your own capabilities)
Your selection? 4
RSA keys may be between 1024 and 4096 bits long.
What keysize do you want? (2048) 4096
Requested keysize is 4096 bits
Please specify how long the key should be valid.
         0 = key does not expire
      &lt;n&gt;  = key expires in n days
      &lt;n&gt;w = key expires in n weeks
      &lt;n&gt;m = key expires in n months
      &lt;n&gt;y = key expires in n years
Key is valid for? (0) 1y
Key expires at Mon 10 Sep 2018 00:00:00 PM UTC
Is this correct? (y/N) y
Really create? (y/N) y
We need to generate a lot of random bytes. It is a good idea to perform
some other action (type on the keyboard, move the mouse, utilize the
disks) during the prime generation; this gives the random number
generator a better chance to gain enough entropy.

sec  rsa4096/0xFF3E7D88647EBCDB
    created: 2017-10-09  expires: never       usage: C
    trust: ultimate      validity: ultimate
ssb  rsa4096/0xBECFA3C1AE191D15
    created: 2017-10-09  expires: 2018-10-09       usage: S
[ultimate] (1). Dr Duh &lt;doc@duh.to&gt;
</code></pre></div><h2 id="encryption">Encryption</h2>
<p>Next, create an <a href="https://www.cs.cornell.edu/courses/cs5430/2015sp/notes/rsa_sign_vs_dec.php">encryption key</a> by selecting <code>(6) RSA (encrypt only)</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">gpg&gt; addkey
Please select what kind of key you want:
   (3) DSA (sign only)
   (4) RSA (sign only)
   (5) Elgamal (encrypt only)
   (6) RSA (encrypt only)
   (7) DSA (set your own capabilities)
   (8) RSA (set your own capabilities)
  (10) ECC (sign only)
  (11) ECC (set your own capabilities)
  (12) ECC (encrypt only)
  (13) Existing key
Your selection? 6
RSA keys may be between 1024 and 4096 bits long.
What keysize do you want? (2048) 4096
Requested keysize is 4096 bits
Please specify how long the key should be valid.
         0 = key does not expire
      &lt;n&gt;  = key expires in n days
      &lt;n&gt;w = key expires in n weeks
      &lt;n&gt;m = key expires in n months
      &lt;n&gt;y = key expires in n years
Key is valid for? (0) 1y
Key expires at Mon 10 Sep 2018 00:00:00 PM UTC
Is this correct? (y/N) y
Really create? (y/N) y
We need to generate a lot of random bytes. It is a good idea to perform
some other action (type on the keyboard, move the mouse, utilize the
disks) during the prime generation; this gives the random number
generator a better chance to gain enough entropy.

sec  rsa4096/0xFF3E7D88647EBCDB
    created: 2017-10-09  expires: never       usage: C
    trust: ultimate      validity: ultimate
ssb  rsa4096/0xBECFA3C1AE191D15
    created: 2017-10-09  expires: 2018-10-09       usage: S
ssb  rsa4096/0x5912A795E90DD2CF
    created: 2017-10-09  expires: 2018-10-09       usage: E
[ultimate] (1). Dr Duh &lt;doc@duh.to&gt;
</code></pre></div><h2 id="authentication">Authentication</h2>
<p>Finally, create an <a href="https://superuser.com/questions/390265/what-is-a-gpg-with-authenticate-capability-used-for">authentication key</a>.</p>
<p>GPG doesn't provide an authenticate-only key type, so select <code>(8) RSA (set your own capabilities)</code> and toggle the required capabilities until the only allowed action is <code>Authenticate</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">gpg&gt; addkey
Please select what kind of key you want:
   (3) DSA (sign only)
   (4) RSA (sign only)
   (5) Elgamal (encrypt only)
   (6) RSA (encrypt only)
   (7) DSA (set your own capabilities)
   (8) RSA (set your own capabilities)
  (10) ECC (sign only)
  (11) ECC (set your own capabilities)
  (12) ECC (encrypt only)
  (13) Existing key
Your selection? 8

Possible actions for a RSA key: Sign Encrypt Authenticate
Current allowed actions: Sign Encrypt

   (S) Toggle the sign capability
   (E) Toggle the encrypt capability
   (A) Toggle the authenticate capability
   (Q) Finished

Your selection? S

Possible actions for a RSA key: Sign Encrypt Authenticate
Current allowed actions: Encrypt

   (S) Toggle the sign capability
   (E) Toggle the encrypt capability
   (A) Toggle the authenticate capability
   (Q) Finished

Your selection? E

Possible actions for a RSA key: Sign Encrypt Authenticate
Current allowed actions:

   (S) Toggle the sign capability
   (E) Toggle the encrypt capability
   (A) Toggle the authenticate capability
   (Q) Finished

Your selection? A

Possible actions for a RSA key: Sign Encrypt Authenticate
Current allowed actions: Authenticate

   (S) Toggle the sign capability
   (E) Toggle the encrypt capability
   (A) Toggle the authenticate capability
   (Q) Finished

Your selection? Q
RSA keys may be between 1024 and 4096 bits long.
What keysize do you want? (2048) 4096
Requested keysize is 4096 bits
Please specify how long the key should be valid.
         0 = key does not expire
      &lt;n&gt;  = key expires in n days
      &lt;n&gt;w = key expires in n weeks
      &lt;n&gt;m = key expires in n months
      &lt;n&gt;y = key expires in n years
Key is valid for? (0) 1y
Key expires at Mon 10 Sep 2018 00:00:00 PM UTC
Is this correct? (y/N) y
Really create? (y/N) y
We need to generate a lot of random bytes. It is a good idea to perform
some other action (type on the keyboard, move the mouse, utilize the
disks) during the prime generation; this gives the random number
generator a better chance to gain enough entropy.

sec  rsa4096/0xFF3E7D88647EBCDB
    created: 2017-10-09  expires: never       usage: C
    trust: ultimate      validity: ultimate
ssb  rsa4096/0xBECFA3C1AE191D15
    created: 2017-10-09  expires: 2018-10-09       usage: S
ssb  rsa4096/0x5912A795E90DD2CF
    created: 2017-10-09  expires: 2018-10-09       usage: E
ssb  rsa4096/0x3F29127E79649A3D
    created: 2017-10-09  expires: 2018-10-09       usage: A
[ultimate] (1). Dr Duh &lt;doc@duh.to&gt;
</code></pre></div><p>Finish by saving the keys.</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">gpg&gt; save
</code></pre></div><h2 id="add-extra-emails">Add extra emails</h2>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">gpg&gt; adduid
Real name: Dr Duh
Email address: DrDuh@other.org
Comment:
You selected this USER-ID:
    &#34;Dr Duh &lt;DrDuh@other.org&gt;&#34;

sec  rsa4096/0xFF3E7D88647EBCDB
    created: 2017-10-09  expires: never       usage: SC
    trust: ultimate      validity: ultimate
ssb  rsa4096/0xBECFA3C1AE191D15
    created: 2017-10-09  expires: never       usage: S
ssb  rsa4096/0x5912A795E90DD2CF
    created: 2017-10-09  expires: never       usage: E
ssb  rsa4096/0x3F29127E79649A3D
    created: 2017-10-09  expires: never       usage: A
[ultimate] (1). Dr Duh &lt;doc@duh.to&gt;
[ unknown] (2). Dr Duh &lt;DrDuh@other.org&gt;


gpg&gt; trust
sec  rsa4096/0xFF3E7D88647EBCDB
    created: 2017-10-09  expires: never       usage: SC
    trust: ultimate      validity: ultimate
ssb  rsa4096/0xBECFA3C1AE191D15
    created: 2017-10-09  expires: never       usage: S
ssb  rsa4096/0x5912A795E90DD2CF
    created: 2017-10-09  expires: never       usage: E
ssb  rsa4096/0x3F29127E79649A3D
    created: 2017-10-09  expires: never       usage: A
[ultimate] (1). Dr Duh &lt;doc@duh.to&gt;
[ unknown] (2). Dr Duh &lt;DrDuh@other.org&gt;

Please decide how far you trust this user to correctly verify other users&#39; keys
(by looking at passports, checking fingerprints from different sources, etc.)

  1 = I don&#39;t know or won&#39;t say
  2 = I do NOT trust
  3 = I trust marginally
  4 = I trust fully
  5 = I trust ultimately
  m = back to the main menu

Your decision? 5
Do you really want to set this key to ultimate trust? (y/N) y

sec  rsa4096/0xFF3E7D88647EBCDB
    created: 2017-10-09  expires: never       usage: SC
    trust: ultimate      validity: ultimate
ssb  rsa4096/0xBECFA3C1AE191D15
    created: 2017-10-09  expires: never       usage: S
ssb  rsa4096/0x5912A795E90DD2CF
    created: 2017-10-09  expires: never       usage: E
ssb  rsa4096/0x3F29127E79649A3D
    created: 2017-10-09  expires: never       usage: A
[ultimate] (1). Dr Duh &lt;doc@duh.to&gt;
[ unknown] (2). Dr Duh &lt;DrDuh@other.org&gt;

gpg&gt; save
</code></pre></div><h1 id="verify">Verify</h1>
<p>List the generated secret keys and verify the output:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ gpg -K
/tmp.FLZC0xcM/pubring.kbx
-------------------------------------------------------------------------
sec   rsa4096/0xFF3E7D88647EBCDB 2017-10-09 [C]
      Key fingerprint = 011C E16B D45B 27A5 5BA8  776D FF3E 7D88 647E BCDB
uid                            Dr Duh &lt;doc@duh.to&gt;
ssb   rsa4096/0xBECFA3C1AE191D15 2017-10-09 [S] [expires: 2018-10-09]
ssb   rsa4096/0x5912A795E90DD2CF 2017-10-09 [E] [expires: 2018-10-09]
ssb   rsa4096/0x3F29127E79649A3D 2017-10-09 [A] [expires: 2018-10-09]
</code></pre></div><p>Add any additional identities or email addresses you wish to associate using the <code>adduid</code> command.</p>
<p><strong>Tip</strong> Verify with a OpenPGP <a href="https://riseup.net/en/security/message-security/openpgp/best-practices#openpgp-key-checks">key best practice checker</a>:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ gpg --export $KEYID | hokey lint
</code></pre></div><p>The output will display any problems with your key in red text. If everything is green, your key passes each of the tests. If it is red, your key has failed one of the tests.</p>
<blockquote>
<p>hokey may warn (orange text) about cross certification for the authentication key. GPG's <a href="https://gnupg.org/faq/subkey-cross-certify.html">Signing Subkey Cross-Certification</a> documentation has more detail on cross certification, and gpg v2.2.1 notes &ldquo;subkey <keyid> does not sign and so does not need to be cross-certified&rdquo;. hokey may also indicate a problem (red text) with <code>Key expiration times: []</code> on the primary key (see <a href="#notes">Note #3</a> about not setting an expiry for the primary key).</p>
</blockquote>
<h1 id="export">Export</h1>
<p>The master key and sub-keys will be encrypted with your passphrase when exported.</p>
<p>Save a copy of your keys:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ gpg --armor --export-secret-keys $KEYID &gt; $GNUPGHOME/mastersub.key

$ gpg --armor --export-secret-subkeys $KEYID &gt; $GNUPGHOME/sub.key
</code></pre></div><p>On Windows, note that using any extension other than <code>.gpg</code> or attempting IO redirection to a file will garble the secret key, making it impossible to import it again at a later date:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ gpg -o \path\to\dir\mastersub.gpg --armor --export-secret-keys $KEYID

$ gpg -o \path\to\dir\sub.gpg --armor --export-secret-subkeys $KEYID
</code></pre></div><h1 id="backup">Backup</h1>
<p>Once keys are moved to YubiKey, they cannot be moved again! Create an <strong>encrypted</strong> backup of the keyring and consider using a <a href="https://www.jabberwocky.com/software/paperkey/">paper copy</a> of the keys as an additional backup measure.</p>
<p><strong>Tip</strong> The ext2 filesystem (without encryption) can be mounted on both Linux and OpenBSD. Consider using a FAT32/NTFS filesystem for MacOS/Windows compatibility instead.</p>
<p><strong>Linux</strong></p>
<p>Attach another external storage device and check its label:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ sudo dmesg | tail
usb-storage 4-2:1.0: USB Mass Storage device detected
scsi host7: usb-storage 4-2:1.0
scsi 7:0:0:0: Direct-Access     TS-RDF5  SD  Transcend    TS37 PQ: 0 ANSI: 6
sd 7:0:0:0: Attached scsi generic sg1 type 0
sd 7:0:0:0: [sdb] 31116288 512-byte logical blocks: (15.9 GB/14.8 GiB)
sd 7:0:0:0: [sdb] Write Protect is off
sd 7:0:0:0: [sdb] Mode Sense: 23 00 00 00
sdb: sdb1
sd 7:0:0:0: [sdb] Attached SCSI removable disk
</code></pre></div><p>Write it with random data to prepare for encryption:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ sudo dd if=/dev/urandom of=/dev/sdb bs=4M status=progress
</code></pre></div><p>Erase and create a new partition table:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ sudo fdisk /dev/sdb
Welcome to fdisk (util-linux 2.33.1).

Command (m for help): o
Created a new DOS disklabel with disk identifier 0xeac7ee35.

Command (m for help): w
The partition table has been altered.
Calling ioctl() to re-read partition table.
Syncing disks.
</code></pre></div><p>Create a new partition with a 25 Megabyte size:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ sudo fdisk /dev/sdb
Welcome to fdisk (util-linux 2.33.1).

Command (m for help): n
Partition type
   p   primary (0 primary, 0 extended, 4 free)
   e   extended (container for logical partitions)
Select (default p):
Partition number (1-4, default 1):
First sector (2048-62980095, default 2048):
Last sector, +sectors or +size{K,M,G,T,P} (2048-62980095, default 62980095): +25M

Created a new partition 1 of type &#39;Linux&#39; and of size 25 MiB.

Command (m for help): w
The partition table has been altered.
Calling ioctl() to re-read partition table.
Syncing disks.
</code></pre></div><p>Use <a href="https://askubuntu.com/questions/97196/how-secure-is-an-encrypted-luks-filesystem">LUKS</a> to encrypt the new partition:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ sudo cryptsetup luksFormat /dev/sdb1

WARNING!
========
This will overwrite data on /dev/sdb1 irrevocably.

Are you sure? (Type uppercase yes): YES
Enter passphrase:
Verify passphrase:
</code></pre></div><p>Mount the partition:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ sudo cryptsetup luksOpen /dev/sdb1 usb
Enter passphrase for /dev/sdb1:
</code></pre></div><p>Create a filesystem:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ sudo mkfs.ext2 /dev/mapper/usb -L usb
Creating filesystem with 10240 1k blocks and 2560 inodes
Superblock backups stored on blocks:
        8193

Allocating group tables: done
Writing inode tables: done
Writing superblocks and filesystem accounting information: done
</code></pre></div><p>Mount the filesystem and copy the temporary directory with the keyring:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ sudo mkdir /mnt/encrypted-usb

$ sudo mount /dev/mapper/usb /mnt/encrypted-usb

$ sudo cp -avi $GNUPGHOME /mnt/encrypted-usb
</code></pre></div><p><strong>Optional</strong> Backup the OneRNG package:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ sudo cp onerng_3.6-1_all.deb /mnt/encrypted-usb
</code></pre></div><p>Keep the backup mounted if you plan on setting up two or more keys as <code>keytocard</code> <strong>will <a href="https://lists.gnupg.org/pipermail/gnupg-users/2016-July/056353.html">delete</a> the local copy</strong> on save.</p>
<p>Unmount, close and disconnected the encrypted volume:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ sudo umount /mnt/encrypted-usb

$ sudo cryptsetup luksClose usb
</code></pre></div><p>Create another partition to store the public key, or skip this step if you plan on uploading it to a key server.</p>
<p><strong>Important</strong> Without the <em>public</em> key, you will not be able to use GPG to encrypt, decrypt, nor sign messages. However, you will still be able to use YubiKey for SSH authentication.</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ sudo fdisk /dev/sdb

Command (m for help): n
Partition type
   p   primary (1 primary, 0 extended, 3 free)
   e   extended (container for logical partitions)
Select (default p):
Partition number (2-4, default 2):
First sector (22528-31116287, default 22528):
Last sector, +sectors or +size{K,M,G,T,P} (22528-31116287, default 31116287): +25M

Created a new partition 2 of type &#39;Linux&#39; and of size 25 MiB.

Command (m for help): w
The partition table has been altered.
Calling ioctl() to re-read partition table.
Syncing disks.

$ sudo mkfs.ext2 /dev/sdb2
Creating filesystem with 10240 1k blocks and 2560 inodes
Superblock backups stored on blocks:
        8193

Allocating group tables: done
Writing inode tables: done
Writing superblocks and filesystem accounting information: done

$ sudo mkdir /mnt/public

$ sudo mount /dev/sdb2 /mnt/public/

$ gpg --armor --export $KEYID | sudo tee /mnt/public/$KEYID-$(date +%F).txt
</code></pre></div><p>Windows:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ gpg -o \path\to\dir\pubkey.gpg --armor --export $KEYID
</code></pre></div><p><strong>Optional</strong> Upload the public key to a <a href="https://debian-administration.org/article/451/Submitting_your_GPG_key_to_a_keyserver">public keyserver</a>:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ gpg --send-key $KEYID

$ gpg --keyserver pgp.mit.edu --send-key $KEYID

$ gpg --keyserver keys.gnupg.net --send-key $KEYID

$ gpg --keyserver hkps://keyserver.ubuntu.com:443 --send-key $KEYID
</code></pre></div><p>After some time, the public key will to propagate to <a href="https://pgp.key-server.io/pks/lookup?search=doc%40duh.to&amp;fingerprint=on&amp;op=vindex">other</a> <a href="https://pgp.mit.edu/pks/lookup?search=doc%40duh.to&amp;op=index">servers</a>.</p>
<p><strong>OpenBSD</strong></p>
<p>Attach a USB disk and determine its label:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ dmesg | grep sd.\ at
sd2 at scsibus5 targ 1 lun 0: &lt;TS-RDF5, SD Transcend, TS37&gt; SCSI4 0/direct removable serial.00000000000000000000
</code></pre></div><p>Print the existing partitions to make sure it's the right device:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ doas disklabel -h sd2
</code></pre></div><p>Initialize the disk by creating an <code>a</code> partition with FS type <code>RAID</code> and size of 25 Megabytes:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ doas fdisk -iy sd2
Writing MBR at offset 0.

$ doas disklabel -E sd2
Label editor (enter &#39;?&#39; for help at any prompt)
sd2&gt; a a
offset: [64]
size: [31101776] 25M
FS type: [4.2BSD] RAID
sd2*&gt; w
sd2&gt; q
No label changes
</code></pre></div><p>Encrypt with bioctl:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ doas bioctl -c C -l sd2a softraid0
New passphrase:
Re-type passphrase:
softraid0: CRYPTO volume attached as sd3
</code></pre></div><p>Create an <code>i</code> partition on the new crypto volume and the filesystem:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ doas fdisk -iy sd3
Writing MBR at offset 0.

$ doas disklabel -E sd3
Label editor (enter &#39;?&#39; for help at any prompt)
sd3&gt; a i
offset: [64]
size: [16001]
FS type: [4.2BSD]
sd3*&gt; w
sd3&gt; q
No label changes.

$ doas newfs sd3i
</code></pre></div><p>Mount the filesystem and copy the temporary directory with the keyring:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ doas mkdir /mnt/encrypted-usb

$ doas mount /dev/sd3i /mnt/encrypted-usb

$ doas cp -avi $GNUPGHOME /mnt/encrypted-usb
</code></pre></div><p>Keep the backup mounted if you plan on setting up two or more keys as <code>keytocard</code> <strong>will <a href="https://lists.gnupg.org/pipermail/gnupg-users/2016-July/056353.html">delete</a> the local copy</strong> on save.</p>
<p>Otherwise, unmount and disconnected the encrypted volume:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ doas umount /mnt/encrypted-usb

$ doas bioctl -d sd3
</code></pre></div><p>See <a href="https://www.openbsd.org/faq/faq14.html#softraidCrypto">OpenBSD FAQ#14</a> for more information.</p>
<p>Create another partition to store the public key, or skip this step if you plan on uploading it to a key server.</p>
<p><strong>Important</strong> Without the public key, you will not be able to use GPG to encrypt, decrypt, nor sign messages. However, you will still be able to use YubiKey for SSH authentication.</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ doas disklabel -E sd2
Label editor (enter &#39;?&#39; for help at any prompt)
sd2&gt; a b
offset: [32130]
size: [31069710] 25M
FS type: [swap] 4.2BSD
sd2*&gt; w
sd2&gt; q
No label changes.

$ doas newfs sd2b

$ doas mkdir /mnt/public

$ doas mount /dev/sd2b /mnt/public

$ gpg --armor --export $KEYID | doas tee /mnt/public/$KEYID.txt
</code></pre></div><h1 id="configure-smartcard">Configure Smartcard</h1>
<p><strong>Windows</strong> Use the <a href="https://developers.yubico.com/yubikey-manager">YubiKey Manager</a> application (note, this not the similarly named older YubiKey NEO Manager) to enable CCID functionality.</p>
<p>Use GPG to configure YubiKey as a smartcard:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ gpg --card-edit
Reader ...........: Yubico Yubikey 4 OTP U2F CCID
Application ID ...: D2760001240102010006055532110000
Version ..........: 3.4
Manufacturer .....: Yubico
Serial number ....: 05553211
Name of cardholder: [not set]
Language prefs ...: [not set]
Sex ..............: unspecified
URL of public key : [not set]
Login data .......: [not set]
Signature PIN ....: not forced
Key attributes ...: rsa2048 rsa2048 rsa2048
Max. PIN lengths .: 127 127 127
PIN retry counter : 3 0 3
Signature counter : 0
Signature key ....: [none]
Encryption key....: [none]
Authentication key: [none]
General key info..: [none]
</code></pre></div><h2 id="change-pin">Change PIN</h2>
<p>The default PIN is <code>123456</code> and default Admin PIN (PUK) is <code>12345678</code>. CCID-mode PINs can be up to 127 ASCII characters.</p>
<p>The Admin PIN is required for some card operations and to unblock a PIN that has been entered incorrectly more than three times. See the GnuPG documentation on <a href="https://www.gnupg.org/howtos/card-howto/en/ch03s02.html">Managing PINs</a> for details.</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">gpg/card&gt; admin
Admin commands are allowed

gpg/card&gt; passwd
gpg: OpenPGP card no. D2760001240102010006055532110000 detected

1 - change PIN
2 - unblock PIN
3 - change Admin PIN
4 - set the Reset Code
Q - quit

Your selection? 3
PIN changed.

1 - change PIN
2 - unblock PIN
3 - change Admin PIN
4 - set the Reset Code
Q - quit

Your selection? 1
PIN changed.

1 - change PIN
2 - unblock PIN
3 - change Admin PIN
4 - set the Reset Code
Q - quit

Your selection? q
</code></pre></div><h2 id="set-information">Set information</h2>
<p>Some fields are optional.</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">gpg/card&gt; name
Cardholder&#39;s surname: Duh
Cardholder&#39;s given name: Dr

gpg/card&gt; lang
Language preferences: en

gpg/card&gt; login
Login data (account name): doc@duh.to

gpg/card&gt; list

Application ID ...: D2760001240102010006055532110000
Version ..........: 3.4
Manufacturer .....: unknown
Serial number ....: 05553211
Name of cardholder: Dr Duh
Language prefs ...: en
Sex ..............: unspecified
URL of public key : [not set]
Login data .......: doc@duh.to
Private DO 4 .....: [not set]
Signature PIN ....: not forced
Key attributes ...: rsa2048 rsa2048 rsa2048
Max. PIN lengths .: 127 127 127
PIN retry counter : 3 0 3
Signature counter : 0
Signature key ....: [none]
Encryption key....: [none]
Authentication key: [none]
General key info..: [none]

gpg/card&gt; quit
</code></pre></div><h1 id="transfer-keys">Transfer keys</h1>
<p><strong>Important</strong> Transferring keys to YubiKey using <code>keytocard</code> is a destructive, one-way operation only. Make sure you've made a backup before proceeding: <code>keytocard</code> converts the local, on-disk key into a stub, which means the on-disk copy is no longer usable to transfer to subsequent security key devices or mint additional keys.</p>
<p>Previous GPG versions required the <code>toggle</code> command before selecting keys. The currently selected key(s) are indicated with an <code>*</code>. When moving keys only one key should be selected at a time.</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ gpg --edit-key $KEYID

Secret key is available.

sec  rsa4096/0xFF3E7D88647EBCDB
    created: 2017-10-09  expires: never       usage: C
    trust: ultimate      validity: ultimate
ssb  rsa4096/0xBECFA3C1AE191D15
    created: 2017-10-09  expires: 2018-10-09  usage: S
ssb  rsa4096/0x5912A795E90DD2CF
    created: 2017-10-09  expires: 2018-10-09  usage: E
ssb  rsa4096/0x3F29127E79649A3D
    created: 2017-10-09  expires: 2018-10-09  usage: A
[ultimate] (1). Dr Duh &lt;doc@duh.to&gt;
</code></pre></div><h2 id="signing-1">Signing</h2>
<p>Select and move the signature key. You will be prompted for the key passphrase and Admin PIN.</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">gpg&gt; key 1

sec  rsa4096/0xFF3E7D88647EBCDB
    created: 2017-10-09  expires: never       usage: C
    trust: ultimate      validity: ultimate
ssb* rsa4096/0xBECFA3C1AE191D15
    created: 2017-10-09  expires: 2018-10-09  usage: S
ssb  rsa4096/0x5912A795E90DD2CF
    created: 2017-10-09  expires: 2018-10-09  usage: E
ssb  rsa4096/0x3F29127E79649A3D
    created: 2017-10-09  expires: 2018-10-09  usage: A
[ultimate] (1). Dr Duh &lt;doc@duh.to&gt;

gpg&gt; keytocard
Please select where to store the key:
   (1) Signature key
   (3) Authentication key
Your selection? 1

You need a passphrase to unlock the secret key for
user: &#34;Dr Duh &lt;doc@duh.to&gt;&#34;
4096-bit RSA key, ID 0xBECFA3C1AE191D15, created 2016-05-24
</code></pre></div><h2 id="encryption-1">Encryption</h2>
<p>Type <code>key 1</code> again to de-select and <code>key 2</code> to select the next key:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">gpg&gt; key 1

gpg&gt; key 2

sec  rsa4096/0xFF3E7D88647EBCDB
    created: 2017-10-09  expires: never       usage: C
    trust: ultimate      validity: ultimate
ssb  rsa4096/0xBECFA3C1AE191D15
    created: 2017-10-09  expires: 2018-10-09  usage: S
ssb* rsa4096/0x5912A795E90DD2CF
    created: 2017-10-09  expires: 2018-10-09  usage: E
ssb  rsa4096/0x3F29127E79649A3D
    created: 2017-10-09  expires: 2018-10-09  usage: A
[ultimate] (1). Dr Duh &lt;doc@duh.to&gt;

gpg&gt; keytocard
Please select where to store the key:
   (2) Encryption key
Your selection? 2

[...]
</code></pre></div><h2 id="authentication-1">Authentication</h2>
<p>Type <code>key 2</code> again to deselect and <code>key 3</code> to select the last key:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">gpg&gt; key 2

gpg&gt; key 3

sec  rsa4096/0xFF3E7D88647EBCDB
    created: 2017-10-09  expires: never       usage: C
    trust: ultimate      validity: ultimate
ssb  rsa4096/0xBECFA3C1AE191D15
    created: 2017-10-09  expires: 2018-10-09  usage: S
ssb  rsa4096/0x5912A795E90DD2CF
    created: 2017-10-09  expires: 2018-10-09  usage: E
ssb* rsa4096/0x3F29127E79649A3D
    created: 2017-10-09  expires: 2018-10-09  usage: A
[ultimate] (1). Dr Duh &lt;doc@duh.to&gt;

gpg&gt; keytocard
Please select where to store the key:
   (3) Authentication key
Your selection? 3

gpg&gt; save
</code></pre></div><h1 id="verify-card">Verify card</h1>
<p>Verify the sub-keys have been moved to YubiKey as indicated by <code>ssb&gt;</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ gpg -K
/tmp.FLZC0xcM/pubring.kbx
-------------------------------------------------------------------------
sec   rsa4096/0xFF3E7D88647EBCDB 2017-10-09 [C]
      Key fingerprint = 011C E16B D45B 27A5 5BA8  776D FF3E 7D88 647E BCDB
uid                            Dr Duh &lt;doc@duh.to&gt;
ssb&gt;  rsa4096/0xBECFA3C1AE191D15 2017-10-09 [S] [expires: 2018-10-09]
ssb&gt;  rsa4096/0x5912A795E90DD2CF 2017-10-09 [E] [expires: 2018-10-09]
ssb&gt;  rsa4096/0x3F29127E79649A3D 2017-10-09 [A] [expires: 2018-10-09]
</code></pre></div><h1 id="cleanup">Cleanup</h1>
<p>Ensure you have:</p>
<ul>
<li>Saved the encryption, signing and authentication sub-keys to YubiKey.</li>
<li>Saved the YubiKey PINs which you changed from defaults.</li>
<li>Saved the password to the master key.</li>
<li>Saved a copy of the master key, sub-keys and revocation certificates on an encrypted volume, to be stored offline.</li>
<li>Saved the password to that encrypted volume in a separate location.</li>
<li>Saved a copy of the public key somewhere easily accessible later.</li>
</ul>
<p>Reboot or <a href="http://srm.sourceforge.net/">securely delete</a> <code>$GNUPGHOME</code> and remove the secret keys from the GPG keyring:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ sudo srm -r $GNUPGHOME || sudo rm -rf $GNUPGHOME

$ gpg --delete-secret-key $KEYID
</code></pre></div><p><strong>Important</strong> Make sure you have securely erased all generated keys and revocation certificates if an ephemeral enviroment was not used!</p>
<h1 id="using-keys">Using keys</h1>
<p>Download <a href="https://github.com/drduh/config/blob/master/gpg.conf">drduh/config/gpg.conf</a>:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ cd ~/.gnupg ; wget https://raw.githubusercontent.com/drduh/config/master/gpg.conf

$ chmod 600 gpg.conf
</code></pre></div><p>Install the required packages and mount the non-encrypted volume created earlier:</p>
<p><strong>Linux</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ sudo apt update &amp;&amp; sudo apt install -y gnupg2 gnupg-agent gnupg-curl scdaemon pcscd

$ sudo mount /dev/sdb2 /mnt
</code></pre></div><p><strong>OpenBSD</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ doas pkg_add gnupg pcsc-tools

$ doas mount /dev/sd2b /mnt
</code></pre></div><p>Import the public key file:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ gpg --import /mnt/0x*txt
gpg: key 0xFF3E7D88647EBCDB: public key &#34;Dr Duh &lt;doc@duh.to&gt;&#34; imported
gpg: Total number processed: 1
gpg:               imported: 1
</code></pre></div><p>Or download the public key from a keyserver:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ gpg --recv $KEYID
gpg: requesting key 0xFF3E7D88647EBCDB from hkps server hkps.pool.sks-keyservers.net
[...]
gpg: key 0xFF3E7D88647EBCDB: public key &#34;Dr Duh &lt;doc@duh.to&gt;&#34; imported
gpg: Total number processed: 1
gpg:               imported: 1
</code></pre></div><p>Edit the master key to assign it ultimate trust by selecting <code>trust</code> and <code>5</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ export KEYID=0xFF3E7D88647EBCDB

$ gpg --edit-key $KEYID

gpg&gt; trust
pub  4096R/0xFF3E7D88647EBCDB  created: 2016-05-24  expires: never       usage: C
                               trust: unknown       validity: unknown
sub  4096R/0xBECFA3C1AE191D15  created: 2017-10-09  expires: 2018-10-09  usage: S
sub  4096R/0x5912A795E90DD2CF  created: 2017-10-09  expires: 2018-10-09  usage: E
sub  4096R/0x3F29127E79649A3D  created: 2017-10-09  expires: 2018-10-09  usage: A
[ unknown] (1). Dr Duh &lt;doc@duh.to&gt;

Please decide how far you trust this user to correctly verify other users&#39; keys
(by looking at passports, checking fingerprints from different sources, etc.)

  1 = I don&#39;t know or won&#39;t say
  2 = I do NOT trust
  3 = I trust marginally
  4 = I trust fully
  5 = I trust ultimately
  m = back to the main menu

Your decision? 5
Do you really want to set this key to ultimate trust? (y/N) y

pub  4096R/0xFF3E7D88647EBCDB  created: 2016-05-24  expires: never       usage: C
                               trust: ultimate      validity: unknown
sub  4096R/0xBECFA3C1AE191D15  created: 2017-10-09  expires: 2018-10-09  usage: S
sub  4096R/0x5912A795E90DD2CF  created: 2017-10-09  expires: 2018-10-09  usage: E
sub  4096R/0x3F29127E79649A3D  created: 2017-10-09  expires: 2018-10-09  usage: A
[ unknown] (1). Dr Duh &lt;doc@duh.to&gt;

gpg&gt; quit
</code></pre></div><p>Remove and re-insert YubiKey and check the status:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ gpg --card-status
Reader ...........: Yubico YubiKey OTP FIDO CCID 00 00
Application ID ...: D2760001240102010006055532110000
Version ..........: 3.4
Manufacturer .....: Yubico
Serial number ....: 05553211
Name of cardholder: Dr Duh
Language prefs ...: en
Sex ..............: unspecified
URL of public key : [not set]
Login data .......: doc@duh.to
Signature PIN ....: not forced
Key attributes ...: rsa4096 rsa4096 rsa4096
Max. PIN lengths .: 127 127 127
PIN retry counter : 3 3 3
Signature counter : 0
Signature key ....: 07AA 7735 E502 C5EB E09E  B8B0 BECF A3C1 AE19 1D15
      created ....: 2016-05-24 23:22:01
Encryption key....: 6F26 6F46 845B BEB8 BDF3  7E9B 5912 A795 E90D D2CF
      created ....: 2016-05-24 23:29:03
Authentication key: 82BE 7837 6A3F 2E7B E556  5E35 3F29 127E 7964 9A3D
      created ....: 2016-05-24 23:36:40
General key info..: pub  4096R/0xBECFA3C1AE191D15 2016-05-24 Dr Duh &lt;doc@duh.to&gt;
sec#  4096R/0xFF3E7D88647EBCDB  created: 2016-05-24  expires: never
ssb&gt;  4096R/0xBECFA3C1AE191D15  created: 2017-10-09  expires: 2018-10-09
                      card-no: 0006 05553211
ssb&gt;  4096R/0x5912A795E90DD2CF  created: 2017-10-09  expires: 2018-10-09
                      card-no: 0006 05553211
ssb&gt;  4096R/0x3F29127E79649A3D  created: 2017-10-09  expires: 2018-10-09
                      card-no: 0006 05553211
</code></pre></div><p><code>sec#</code> indicates master key is not available (as it should be stored encrypted offline).</p>
<p><strong>Note</strong> If you see <code>General key info..: [none]</code> in the output instead - go back and import the public key using the previous step.</p>
<p>Encrypt a message to your own key (useful for storing password credentials and other data):</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ echo &#34;test message string&#34; | gpg --encrypt --armor --recipient $KEYID -o encrypted.txt
</code></pre></div><p>To encrypt to multiple recipients (or to multiple keys):</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ echo &#34;test message string&#34; | gpg --encrypt --armor --recipient $KEYID_0 --recipient $KEYID_1 --recipient $KEYID_2 -o encrypted.txt
</code></pre></div><p>Decrypt the message:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ gpg --decrypt --armor encrypted.txt
gpg: anonymous recipient; trying secret key 0x0000000000000000 ...
gpg: okay, we are the anonymous recipient.
gpg: encrypted with RSA key, ID 0x0000000000000000
test message string
</code></pre></div><p>Sign a message:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ echo &#34;test message string&#34; | gpg --armor --clearsign &gt; signed.txt
</code></pre></div><p>Verify the signature:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ gpg --verify signed.txt
gpg: Signature made Wed 25 May 2016 00:00:00 AM UTC
gpg:                using RSA key 0xBECFA3C1AE191D15
gpg: Good signature from &#34;Dr Duh &lt;doc@duh.to&gt;&#34; [ultimate]
Primary key fingerprint: 011C E16B D45B 27A5 5BA8  776D FF3E 7D88 647E BCDB
     Subkey fingerprint: 07AA 7735 E502 C5EB E09E  B8B0 BECF A3C1 AE19 1D15
</code></pre></div><h1 id="rotating-keys">Rotating keys</h1>
<p>PGP does not provide forward secrecy - a compromised key may be used to decrypt all past messages. Although keys stored on YubiKey are difficult to steal, it is not impossible - the key and PIN could be taken, or a vulnerability may be discovered in key hardware or random number generator used to create them, for example. Therefore, it is good practice to occassionally rotate sub-keys.</p>
<p>When a sub-key expires, it can either be renewed or replaced. Both actions require access to the offline master key. Renewing sub-keys by updating their expiration date indicates you are still in possession of the offline master key and is more convenient.</p>
<p>Replacing keys, on the other hand, is less convenient but more secure: the new sub-keys will <strong>not</strong> be able to decrypt previous messages, authenticate with SSH, etc. Contacts will need to receive the updated public key and any encrypted secrets need to be decrypted and re-encrypted to new sub-keys to be usable. This process is functionally equivalent to &ldquo;losing&rdquo; the YubiKey and provisioning a new one. However, you will always be able to decrypt previous messages using the offline encrypted backup of the original keys.</p>
<p>Neither rotation method is superior and it's up to personal philosophy on identity management and individual threat model to decide which one to use, or whether to expire sub-keys at all. Ideally, sub-keys would be ephemeral: used only once for each encryption, signing and authentication event, however in practice that is not really feasible or worthwhile with YubiKey. Advanced users may want to dedicate an offline device for more frequent key rotations and ease of provisioning.</p>
<p>To renew or rotate sub-keys, follow the same procedure to boot to a secure environment. Install required software and disconnect networking. Decrypt and mount the offline volume, then import the master key and configuration to a temporary working directory:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ export GNUPGHOME=$(mktemp -d)

$ gpg --import /mnt/encrypted-usb/tmp.XXX/mastersub.key

$ cp -v /mnt/encrypted-usb/tmp.XXX/gpg.conf $GNUPGHOME
</code></pre></div><p>Edit the master key:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ export KEYID=0xFF3E7D88647EBCDB

$ gpg --edit-key $KEYID

Secret key is available
[...]
</code></pre></div><p>Follow the original steps to generate each sub-key. Previous sub-keys may be kept or deleted from the identity.</p>
<p>Finish by exporting new keys:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ gpg --armor --export-secret-keys $KEYID &gt; $GNUPGHOME/mastersub.key

$ gpg --armor --export-secret-subkeys $KEYID &gt; $GNUPGHOME/sub.key
</code></pre></div><p>Copy the <strong>new</strong> temporary working directory to encrypted offline storage, which should still be mounted:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ sudo cp -avi $GNUPGHOME /mnt/encrypted-usb
</code></pre></div><p>There should now be at least two versions of the master and sub-keys backed up:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ ls /mnt/encrypted-usb
lost+found  tmp.ykhTOGjR36  tmp.2gyGnyCiHs
</code></pre></div><p>Unmount and close the encrypted volume:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ sudo umount /mnt/encrypted-usb

$ sudo cryptsetup luksClose /dev/mapper/usb/
</code></pre></div><p>Export the updated public key:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ sudo mkdir /mnt/public

$ sudo mount /dev/sdb2 /mnt/public

$ gpg --armor --export $KEYID | sudo tee /mnt/public/$KEYID-$(date +%F).txt

$ sudo umount /mnt/public
</code></pre></div><p>Disconnect the storage device and follow the original steps to transfer new keys (4, 5 and 6) to YubiKey, replacing existing ones. Reboot or securely erase the GPG temporary working directory.</p>
<h1 id="ssh">SSH</h1>
<p><a href="https://wiki.archlinux.org/index.php/GnuPG#SSH_agent">gpg-agent</a> supports the OpenSSH ssh-agent protocol (<code>enable-ssh-support</code>), as well as Putty's Pageant on Windows (<code>enable-putty-support</code>). This means it can be used instead of the traditional ssh-agent / pageant. There are some differences from ssh-agent, notably that gpg-agent does not <em>cache</em> keys rather it converts, encrypts and stores them - persistently - as GPG keys and then makes them available to ssh clients. Any existing ssh private keys that you'd like to keep in <code>gpg-agent</code> should be deleted after they've been imported to the GPG agent.</p>
<p>When importing the key to <code>gpg-agent</code>, you'll be prompted for a passphrase to protect that key within GPG's key store - you may want to use the same passphrase as the original's ssh version. GPG can both cache passphrases for a determined period (ref. <code>gpg-agent</code>'s various <code>cache-ttl</code> options), and since version 2.1 can store and fetch passphrases via the macOS keychain. Note than when removing the old private key after importing to <code>gpg-agent</code>, keep the <code>.pub</code> key file around for use in specifying ssh identities (e.g. <code>ssh -i /path/to/identity.pub</code>).</p>
<p>Probably the biggest thing missing from <code>gpg-agent</code>'s ssh agent support is being able to remove keys. <code>ssh-add -d/-D</code> have no effect. Instead, you need to use the <code>gpg-connect-agent</code> utility to lookup a key's keygrip, match that with the desired ssh key fingerprint (as an MD5) and then delete that keygrip. The <a href="https://lists.gnupg.org/pipermail/gnupg-users/2016-August/056499.html">gnupg-users mailing list</a> has more information.</p>
<h2 id="create-configuration">Create configuration</h2>
<p>Create a hardened configuration for gpg-agent by downloading <a href="https://github.com/drduh/config/blob/master/gpg-agent.conf">drduh/config/gpg-agent.conf</a>:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ cd ~/.gnupg

$ wget https://raw.githubusercontent.com/drduh/config/master/gpg-agent.conf

$ grep -ve &#34;^#&#34; gpg-agent.conf
enable-ssh-support
default-cache-ttl 60
max-cache-ttl 120
pinentry-program /usr/bin/pinentry-curses
</code></pre></div><p><strong>Important</strong> The <code>cache-ttl</code> options do <strong>NOT</strong> apply when using a YubiKey as a smartcard as the PIN is <a href="https://dev.gnupg.org/T3362">cached by the smartcard itself</a>. Therefore, in order to clear the PIN from cache (smartcard equivalent to <code>default-cache-ttl</code> and <code>max-cache-ttl</code>), you need to unplug the YubiKey.</p>
<p><strong>Tip</strong> Set <code>pinentry-program /usr/bin/pinentry-gnome3</code> for a GUI-based prompt. If the <em>pinentry</em> graphical dialog doesn't show and you get this error: <code>sign_and_send_pubkey: signing failed: agent refused operation</code>, you may need to install the <code>dbus-user-session</code> package and restart the computer for the <code>dbus</code> user session to be fully inherited; this is because behind the scenes, <code>pinentry</code> complains about <code>No $DBUS_SESSION_BUS_ADDRESS found</code>, falls back to <code>curses</code> but doesn't find the expected <code>tty</code>.</p>
<p>On macOS, use <code>brew install pinentry-mac</code> and set the program path to <code>pinentry-program /usr/local/bin/pinentry-mac</code> or <code>pinentry-program /usr/local/MacGPG2/libexec/pinentry-mac.app/Contents/MacOS/pinentry-mac</code> if using MacGPG Suite.</p>
<h2 id="replace-agents">Replace agents</h2>
<p>To launch <code>gpg-agent</code> for use by SSH, use the <code>gpg-connect-agent /bye</code> or <code>gpgconf --launch gpg-agent</code> commands.</p>
<p>Add these to the shell <code>rc</code> file:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">export GPG_TTY=&#34;$(tty)&#34;
export SSH_AUTH_SOCK=&#34;/run/user/$UID/gnupg/S.gpg-agent.ssh&#34;
gpg-connect-agent updatestartuptty /bye &gt; /dev/null
</code></pre></div><p>On modern systems, <code>gpgconf --list-dirs agent-ssh-socket</code> will automatically set <code>SSH_AUTH_SOCK</code> to the correct value and is better than hard-coding to <code>run/user/$UID/gnupg/S.gpg-agent.ssh</code>, if available:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">export GPG_TTY=&#34;$(tty)&#34;
export SSH_AUTH_SOCK=$(gpgconf --list-dirs agent-ssh-socket)
gpgconf --launch gpg-agent
</code></pre></div><p>Note that <code>SSH_AUTH_SOCK</code> normally only needs to be set on the <em>local</em> laptop (workstation), where the YubiKey is plugged in.  On the <em>remote</em> server that we SSH into, <code>ssh</code> will automatically set <code>SSH_AUTH_SOCK</code> to something like <code>/tmp/ssh-mXzCzYT2Np/agent.7541</code> when we connect.  We therefore do <strong>NOT</strong> manually set <code>SSH_AUTH_SOCK</code> on the server - doing so would break <a href="#remote-machines-agent-forwarding">SSH Agent Forwarding</a>.</p>
<h2 id="copy-public-key">Copy public key</h2>
<p><strong>Note</strong> It is <strong>not</strong> necessary to import the corresponding GPG public key in order to use SSH.</p>
<p>Copy and paste the output from <code>ssh-add</code> to the server's <code>authorized_keys</code> file:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ ssh-add -L
ssh-rsa AAAAB4NzaC1yc2EAAAADAQABAAACAz[...]zreOKM+HwpkHzcy9DQcVG2Nw== cardno:000605553211
</code></pre></div><h2 id="optional-save-public-key-for-identity-file-configuration">(Optional) Save public key for identity file configuration</h2>
<p>By default, SSH attempts to use all the identities available via the agent. It's often a good idea to manage exactly which keys SSH will use to connect to a server, for example to separate different roles or <a href="https://blog.filippo.io/ssh-whoami-filippo-io/">to avoid being fingerprinted by untrusted ssh servers</a>. To do this you'll need to use the command line argument <code>-i [identity_file]</code> or the <code>IdentityFile</code> and <code>IdentitiesOnly</code> options in <code>.ssh/config</code>.</p>
<p>The argument provided to <code>IdentityFile</code> is traditionally the path to the <em>private</em> key file (for example <code>IdentityFile ~/.ssh/id_rsa</code>). For the YubiKey - indeed, in general for keys stored in an ssh agent - <code>IdentityFile</code> should point to the <em>public</em> key file, <code>ssh</code> will select the appropriate private key from those available via the ssh agent. To prevent <code>ssh</code> from trying all keys in the agent use the <code>IdentitiesOnly yes</code> option along with one or more <code>-i</code> or <code>IdentityFile</code> options for the target host.</p>
<p>To reiterate, with <code>IdentitiesOnly yes</code>, <code>ssh</code> will not automatically enumerate public keys loaded into <code>ssh-agent</code> or <code>gpg-agent</code>. This means <code>publickey</code> authentication will not proceed unless explicitly named by <code>ssh -i [identity_file]</code> or in <code>.ssh/config</code> on a per-host basis.</p>
<p>In the case of YubiKey usage, to extract the public key from the ssh agent:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ ssh-add -L | grep &#34;cardno:000605553211&#34; &gt; ~/.ssh/id_rsa_yubikey.pub
</code></pre></div><p>Then you can explicitly associate this YubiKey-stored key for used with a host, <code>github.com</code> for example, as follows:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ cat &lt;&lt; EOF &gt;&gt; ~/.ssh/config
Host github.com
    IdentitiesOnly yes
    IdentityFile ~/.ssh/id_rsa_yubikey.pub
EOF
</code></pre></div><h2 id="connect-with-public-key-authentication">Connect with public key authentication</h2>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ ssh git@github.com -vvv
[...]
debug2: key: cardno:000605553211 (0x1234567890),
debug1: Authentications that can continue: publickey
debug3: start over, passed a different list publickey
debug3: preferred gssapi-keyex,gssapi-with-mic,publickey,keyboard-interactive,password
debug3: authmethod_lookup publickey
debug3: remaining preferred: keyboard-interactive,password
debug3: authmethod_is_enabled publickey
debug1: Next authentication method: publickey
debug1: Offering RSA public key: cardno:000605553211
debug3: send_pubkey_test
debug2: we sent a publickey packet, wait for reply
debug1: Server accepts key: pkalg ssh-rsa blen 535
debug2: input_userauth_pk_ok: fp e5:de:a5:74:b1:3e:96:9b:85:46:e7:28:53:b4:82:c3
debug3: sign_and_send_pubkey: RSA e5:de:a5:74:b1:3e:96:9b:85:46:e7:28:53:b4:82:c3
debug1: Authentication succeeded (publickey).
[...]
</code></pre></div><p><strong>Tip</strong> To make multiple connections or securely transfer many files, consider using the <a href="https://en.wikibooks.org/wiki/OpenSSH/Cookbook/Multiplexing">ControlMaster</a> ssh option. Also see <a href="https://github.com/drduh/config/blob/master/ssh_config">drduh/config/ssh_config</a>.</p>
<h2 id="import-ssh-keys">Import SSH keys</h2>
<p>If there are existing SSH keys that you wish to make available via <code>gpg-agent</code>, you'll need to import them. You should then remove the original private keys. When importing the key, <code>gpg-agent</code> uses the key's filename as the key's label; this makes it easier to follow where the key originated from. In this example, we're starting with just the YubiKey's key in place and importing <code>~/.ssh/id_rsa</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ ssh-add -l
4096 SHA256:... cardno:00060123456 (RSA)

$ ssh-add ~/.ssh/id_rsa &amp;&amp; rm ~/.ssh/id_rsa
</code></pre></div><p>When invoking <code>ssh-add</code>, it will prompt for the SSH key's passphrase if present, then the <code>pinentry</code> program will prompt and confirm for a new passphrase to use to encrypt the converted key within the GPG key store.</p>
<p>The migrated key will be listed in <code>ssh-add -l</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ ssh-add -l
4096 SHA256:... cardno:00060123456 (RSA)
2048 SHA256:... /Users/username/.ssh/id_rsa (RSA)
</code></pre></div><p>Or to show the keys with MD5 fingerprints, as used by <code>gpg-connect-agent</code>'s <code>KEYINFO</code> and <code>DELETE_KEY</code> commands:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ ssh-add -E md5 -l
4096 MD5:... cardno:00060123456 (RSA)
2048 MD5:... /Users/username/.ssh/id_rsa (RSA)
</code></pre></div><p>When using the key <code>pinentry</code> will be invoked to request the key's passphrase. The passphrase will be cached for up to 10 minutes idle time between uses, to a maximum of 2 hours.</p>
<h2 id="remote-machines-agent-forwarding">Remote Machines (Agent Forwarding)</h2>
<p><strong>Note</strong> SSH Agent Forwarding can <a href="https://matrix.org/blog/2019/05/08/post-mortem-and-remediations-for-apr-11-security-incident/#ssh-agent-forwarding-should-be-disabled">add additional risk</a> - proceed with caution!</p>
<p>To use YubiKey to sign a git commit on a remote host, or ssh through another network, configure and use Agent Forwarding.</p>
<p>To do this, you need access to the remote machine and the YubiKey has to be set up on the host machine.</p>
<p>On the remote machine, edit <code>/etc/ssh/sshd_config</code> to set <code>StreamLocalBindUnlink yes</code></p>
<p><strong>Optional</strong> If you do not have root access to the remote machine to edit <code>/etc/ssh/sshd_config</code>, you will need to remove the socket on the remote machine before forwarding works. For example, <code>rm /run/user/1000/gnupg/S.gpg-agent</code>. Further information can be found on the <a href="https://wiki.gnupg.org/AgentForwarding">AgentForwarding GNUPG wiki page</a>.</p>
<p>Import public keys to the remote machine. This can be done by fetching from a keyserver. On the local machine, copy the public keyring to the remote machine:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ scp ~/.gnupg/pubring.kbx remote:~/.gnupg/
</code></pre></div><p>You should now be able use <code>ssh -A remote</code> on the <em>local</em> machine to log into <em>remote</em>, and should then be able to use YubiKey as if it were connected to the remote machine. For example, using e.g. <code>ssh-add -l</code> on that remote machine should show the public key from the YubiKey (note <code>cardno:</code>).  (If you don't want to have to remember to use <code>ssh -A</code>, you can use <code>ForwardAgent yes</code> in <code>~/.ssh/config</code>.  As a security best practice, always use <code>ForwardAgent yes</code> only for a single <code>Hostname</code>, never for all servers.)</p>
<p>On modern distributions, such as Fedora 30, there is typically no need to also set <code>RemoteForward</code> in <code>~/.ssh/config</code> as detailed in the next chapter, because the right thing actually happens automatically.</p>
<h3 id="steps-for-older-distributions">Steps for older distributions</h3>
<p>On the local machine, run:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ gpgconf --list-dirs agent-extra-socket
</code></pre></div><p>This should return a path to agent-extra-socket - <code>/run/user/1000/gnupg/S.gpg-agent.extra</code> - though on older Linux distros (and macOS) it may be <code>/home/&lt;user&gt;/.gnupg/S/gpg-agent.extra</code></p>
<p>Find the agent socket on the <strong>remote</strong> machine:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ gpgconf --list-dirs agent-socket
</code></pre></div><p>This should return a path such as <code>/run/user/1000/gnupg/S.gpg-agent</code></p>
<p>Finally, enable agent forwarding for a given machine by adding the following to the local machine's ssh config file <code>~/.ssh/config</code> (your agent sockets may be different):</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">Host
  Hostname remote-host.tld
  ForwardAgent yes
  RemoteForward /run/user/1000/gnupg/S.gpg-agent /run/user/1000/gnupg/S.gpg-agent.extra
  # RemoteForward [remote socket] [local socket]
</code></pre></div><p>If you're still having problems, it may be necessary to edit <code>gpg-agent.conf</code> file on both the remote and local machines to add the following information:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">enable-ssh-support
pinentry-program /usr/bin/pinentry-curses
extra-socket /run/user/1000/gnupg/S.gpg-agent.extra
</code></pre></div><p>See <a href="https://github.com/drduh/YubiKey-Guide/issues/85">Issue #85</a> for more information and troubleshooting.</p>
<h2 id="github">GitHub</h2>
<p>You can use YubiKey to sign GitHub commits and tags. It can also be used for GitHub SSH authentication, allowing you to push, pull, and commit without a password.</p>
<p>Login to GitHub and upload SSH and PGP public keys in Settings.</p>
<p>To configure a signing key:</p>
<pre><code>&gt; git config --global user.signingkey $KEYID
</code></pre>
<p>Make sure the user.email option matches the email address associated with the PGP identity.</p>
<p>Now, to sign commits or tags simply use the <code>-S</code> option. GPG will automatically query YubiKey and prompt you for a PIN.</p>
<p>To authenticate:</p>
<p><strong>Windows</strong></p>
<p>Run the following command:</p>
<pre><code>&gt; git config --global core.sshcommand 'plink -agent'
</code></pre>
<p>You can then change the repository url to <code>git@github.com:USERNAME/repository</code> and any authenticated commands will be authorized by YubiKey.</p>
<p><strong>Note</strong> If you encounter the error <code>gpg: signing failed: No secret key</code> - run <code>gpg --card-status</code> with YubiKey plugged in and try the git command again.</p>
<h2 id="openbsd-1">OpenBSD</h2>
<p>Install and enable tools for use with PC/SC drivers, cards, readers, then reboot to recognize YubiKey:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ doas pkg_add pcsc-tools

$ doas rcctl enable pcscd

$ doas reboot
</code></pre></div><h2 id="windows-1">Windows</h2>
<p>Windows can already have some virtual smartcard readers installed, like the one provided for Windows Hello. To ensure your YubiKey is the correct one used by scdaemon, you should add it to its configuration. You will need your device's full name. To find out what is your device's full name, plug your YubiKey, open the Device Manager, select &ldquo;View &gt; Show hidden devices&rdquo;. Go to the Software Devices list, you should see something like <code>Yubico YubiKey OTP+FIDO+CCID 0</code>. The name slightly differs according to the model. Thanks to <a href="https://www.hanselman.com/blog/HowToSetupSignedGitCommitsWithAYubiKeyNEOAndGPGAndKeybaseOnWindows.aspx">Scott Hanselman</a> for sharing this information.</p>
<ul>
<li>Create or edit <code>%APPDATA%/gnupg/scdaemon.conf</code> to add:</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">reader-port &lt;your yubikey device&#39;s full name&gt;
</code></pre></div><ul>
<li>Edit <code>%APPDATA%/gnupg/gpg-agent.conf</code> to add:</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">enable-ssh-support
enable-putty-support
</code></pre></div><ul>
<li>Open a command console, restart the agent:</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">&gt; gpg-connect-agent killagent /bye
&gt; gpg-connect-agent /bye
</code></pre></div><ul>
<li>Enter <code>&gt; gpg --card-status</code> to see YubiKey details.</li>
<li>Import the <a href="#export-public-key">public key</a>: <code>&gt; gpg --import &lt;path to public key file&gt;</code></li>
<li><a href="#trust-master-key">Trust the master key</a></li>
<li>Retrieve the public key id: <code>&gt; gpg --list-public-keys</code></li>
<li>Export the SSH key from GPG: <code>&gt; gpg --export-ssh-key &lt;public key id&gt;</code></li>
</ul>
<p>Copy this key to a file for later use. It represents the public SSH key corresponding to the secret key on the YubiKey. You can upload this key to any server you wish to SSH into.</p>
<p>Create a shortcut that points to <code>gpg-connect-agent /bye</code> and place it in the startup folder <code>shell:startup</code> to make sure the agent starts after a system shutdown. Modify the shortcut properties so it starts in a &ldquo;Minimized&rdquo; window, to avoid unnecessary noise at startup.</p>
<p>Now you can use PuTTY for public key SSH authentication. When the server asks for public key verification, PuTTY will forward the request to GPG, which will prompt you for a PIN and authorize the login using YubiKey.</p>
<h3 id="wsl">WSL</h3>
<p>The goal here is to make the SSH client inside WSL work together with the Windows agent you are using (gpg-agent.exe in our case). Here is what we are going to achieve:
<img src="media/schema_gpg.png" alt="WSL agent architecture"></p>
<p><strong>Note</strong> this works only for SSH agent forwarding. Real GPG forwarding (encryption/decryption) is actually not supported. See the <a href="https://github.com/vuori/weasel-pageant">weasel-pageant</a> readme for further information.</p>
<h4 id="prerequisites">Prerequisites</h4>
<ul>
<li>Ubuntu 16.04 or newer for WSL</li>
<li>Kleopatra</li>
<li><a href="#windows">Windows configuration</a></li>
</ul>
<h4 id="wsl-configuration">WSL configuration</h4>
<p>Download or clone <a href="https://github.com/vuori/weasel-pageant">weasel-pageant</a>.</p>
<p>Add <code>eval $(/mnt/c/&lt;path of extraction&gt;/weasel-pageant -r -a /tmp/S.weasel-pageant)</code> to shell rc file. Use a named socket here so it can be used in the <code>RemoteForward</code> directive of <code>~/.ssh/config</code>. Source it with <code>source ~/.bashrc</code>.</p>
<p>Display the SSH key with <code>$ ssh-add -l</code></p>
<p>Edit <code>~/.ssh/config</code> to add the following for each host you want to use agent forwarding:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">ForwardAgent yes
RemoteForward &lt;remote SSH socket path&gt; /tmp/S.weasel-pageant
</code></pre></div><p><strong>Note</strong> The remote SSH socket path can be found with <code>gpgconf --list-dirs agent-ssh-socket</code></p>
<h4 id="remote-host-configuration">Remote host configuration</h4>
<p>You may have to add the following to the shell rc file. On Linux, this is only required on the laptop/workstation where the YubiKey is plugged in, and <strong>NOT</strong> on the remote host server that you connect to; in fact at least on some Linux distributions, changing SSH_AUTH_SOCK on the server breaks agent forwarding.</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">export SSH_AUTH_SOCK=$(gpgconf --list-dirs agent-ssh-socket)
export GPG_TTY=$(tty)
</code></pre></div><p>Add the following to <code>/etc/ssh/sshd_config</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">AllowAgentForwarding yes
StreamLocalBindUnlink yes
</code></pre></div><p>And reload the SSH daemon (e.g., <code>sudo service sshd reload</code>).</p>
<p>Unplug YubiKey, disconnect or reboot. Log back in to Windows, open a WSL console and enter <code>ssh-add -l</code> - you should see nothing.</p>
<p>Plug in YubiKey, enter the same command to display the ssh key.</p>
<p>Log in to the remote host, you should have the pinentry dialog asking for the YubiKey pin.</p>
<p>On the remote host, type <code>ssh-add -l</code> - if you see the ssh key, that means forwarding works!</p>
<p><strong>Note</strong> Agent forwarding may be chained through multiple hosts - just follow the same <a href="#remote-host-configuration">protocol</a> to configure each host.</p>
<h1 id="multiple-keys">Multiple Keys</h1>
<p>To use a single identity with multiple YubiKeys - or to replace a lost card with another - issue this command to switch keys:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ gpg-connect-agent &#34;scd serialno&#34; &#34;learn --force&#34; /bye
</code></pre></div><p>Alternatively, you could manually delete the GnuPG shadowed key - where the card serial number is stored (see <a href="https://dev.gnupg.org/T2291">GnuPG #T2291</a>).</p>
<p>Find the <code>Keygrip</code> number of each key:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ gpg --with-keygrip -k $KEYID
pub   rsa4096/0xFF3E7D88647EBCDB 2017-10-09 [C]
      Key fingerprint = 011C E16B D45B 27A5 5BA8  776D FF3E 7D88 647E BCDB
      Keygrip = 7A20855980A62C10569DE893157F38A696B1300E
uid                  [  ultime ] Dr Duh &lt;doc@duh.to&gt;
sub   rsa4096/0xBECFA3C1AE191D15 2017-10-09 [S] [expires: 2018-10-09]
      Keygrip = 85D44BD52AD45C0852BD15BF41161EE9AE477398
sub   rsa4096/0x5912A795E90DD2CF 2017-10-09 [E] [expires: 2018-10-09]
      Keygrip = A0AA3D9F626BDEA3B833F290C7BCA79216C8A996
sub   rsa4096/0x3F29127E79649A3D 2017-10-09 [A] [expires: 2018-10-09]
      Keygrip = 7EF25A1115294342F451BC1CDD0FA94395F2D074
</code></pre></div><p>Delete all the shadow keys using their <code>Keygrip</code> number:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ cd ~/.gnupg/private-keys-v1.d

$ rm 85D44BD52AD45C0852BD15BF41161EE9AE477398.key \
    A0AA3D9F626BDEA3B833F290C7BCA79216C8A996.key \
    7EF25A1115294342F451BC1CDD0FA94395F2D074.key
</code></pre></div><p>Insert the new YubiKey and re-generate shadow-keys by checking card status:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ gpg --card-status
</code></pre></div><p>See discussion in Issues <a href="https://github.com/drduh/YubiKey-Guide/issues/19">#19</a> and <a href="https://github.com/drduh/YubiKey-Guide/issues/112">#112</a> for more information and troubleshooting steps.</p>
<h1 id="require-touch">Require touch</h1>
<p><strong>Note</strong> This is not possible on YubiKey NEO.</p>
<p>By default, YubiKey will perform encryption, signing and authentication operations without requiring any action from the user, after the key is plugged in and first unlocked with the PIN.</p>
<p>To require a touch for each key operation, install <a href="https://developers.yubico.com/yubikey-manager/">YubiKey Manager</a> and recall the Admin PIN:</p>
<p><strong>Note</strong> Older versions of YubiKey Manager use <code>touch</code> instead of <code>set-touch</code> in the following commands.</p>
<p>Authentication:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ ykman openpgp set-touch aut on
</code></pre></div><p>Signing:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ ykman openpgp set-touch sig on
</code></pre></div><p>Encryption:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ ykman openpgp set-touch enc on
</code></pre></div><p>YubiKey will blink when it is waiting for a touch. On Linux you can also use <a href="https://github.com/maximbaz/yubikey-touch-detector">yubikey-touch-detector</a> to have an indicator or notification that YubiKey is waiting for a touch.</p>
<h1 id="email">Email</h1>
<p>GPG keys on YubiKey can be used with ease to encrypt and/or sign emails and attachments using <a href="https://www.thunderbird.net/">Thunderbird</a> and <a href="https://www.enigmail.net">Enigmail</a>. Thunderbird supports OAuth 2 authentication and can be used with Gmail. See <a href="https://ssd.eff.org/en/module/how-use-pgp-linux">this guide</a> from EFF for detailed instructions.</p>
<h2 id="mailvelope-on-macos">Mailvelope on macOS</h2>
<p><a href="https://www.mailvelope.com/en">Mailvelope</a> allows GPG keys on YubiKey to be used with Gmail and others.</p>
<p>On macOS, install gpgme using Homebrew:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ brew install gpgme
</code></pre></div><p>To allow Chrome to run gpgme, edit <code>~/Library/Application\ Support/Google/Chrome/NativeMessagingHosts/gpgmejson.json</code> and add:</p>
<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
    <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;gpgmejson&#34;</span><span class="p">,</span>
    <span class="nt">&#34;description&#34;</span><span class="p">:</span> <span class="s2">&#34;Integration with GnuPG&#34;</span><span class="p">,</span>
    <span class="nt">&#34;path&#34;</span><span class="p">:</span> <span class="s2">&#34;/usr/local/bin/gpgme-json&#34;</span><span class="p">,</span>
    <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;stdio&#34;</span><span class="p">,</span>
    <span class="nt">&#34;allowed_origins&#34;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&#34;chrome-extension://kajibbejlbohfaggdiogboambcijhkke/&#34;</span>
    <span class="p">]</span>
<span class="p">}</span>
</code></pre></div><p>Edit the default path to allow Chrome to find GPG:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ sudo launchctl config user path /usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin
</code></pre></div><p>Finally, install the <a href="https://chrome.google.com/webstore/detail/mailvelope/kajibbejlbohfaggdiogboambcijhkke">Mailvelope extension</a> from the Chrome app store.</p>
<h1 id="reset">Reset</h1>
<p>If PIN attempts are exceeded, the card is locked and must be <a href="https://developers.yubico.com/ykneo-openpgp/ResetApplet.html">reset</a> and set up again using the encrypted backup.</p>
<p>Copy the following script to a file and run <code>gpg-connect-agent -R $file</code> to lock and terminate the card. Then re-insert YubiKey to reset.</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">/hex
scd serialno
scd apdu 00 20 00 81 08 40 40 40 40 40 40 40 40
scd apdu 00 20 00 81 08 40 40 40 40 40 40 40 40
scd apdu 00 20 00 81 08 40 40 40 40 40 40 40 40
scd apdu 00 20 00 81 08 40 40 40 40 40 40 40 40
scd apdu 00 20 00 83 08 40 40 40 40 40 40 40 40
scd apdu 00 20 00 83 08 40 40 40 40 40 40 40 40
scd apdu 00 20 00 83 08 40 40 40 40 40 40 40 40
scd apdu 00 20 00 83 08 40 40 40 40 40 40 40 40
scd apdu 00 e6 00 00
scd apdu 00 44 00 00
/echo Card has been successfully reset.
</code></pre></div><h1 id="notes">Notes</h1>
<ol>
<li>YubiKey has two configurations: one invoked with a short press, and the other with a long press. By default, the short-press mode is configured for HID OTP - a brief touch will emit an OTP string starting with <code>cccccccc</code>. If you rarely use the OTP mode, you can swap it to the second configuration via the YubiKey Personalization tool. If you <em>never</em> use OTP, you can disable it entirely using the <a href="https://developers.yubico.com/yubikey-manager">YubiKey Manager</a> application (note, this not the similarly named older YubiKey NEO Manager).</li>
<li>Programming YubiKey for GPG keys still lets you use its other configurations - <a href="https://en.wikipedia.org/wiki/Universal_2nd_Factor">U2F</a>, <a href="https://www.yubico.com/faq/what-is-a-one-time-password-otp/">OTP</a> and <a href="https://www.yubico.com/products/services-software/personalization-tools/static-password/">static password</a> modes, for example.</li>
<li>Setting an expiry essentially forces you to manage your subkeys and announces to the rest of the world that you are doing so. Setting an expiry on a primary key is ineffective for protecting the key from loss - whoever has the primary key can simply extend its expiry period. Revocation certificates are <a href="https://security.stackexchange.com/questions/14718/does-openpgp-key-expiration-add-to-security/79386#79386">better suited</a> for this purpose. It may be appropriate for your use case to set expiry dates on subkeys.</li>
<li>To switch between two or more identities on different keys - unplug the first key and restart gpg-agent, ssh-agent and pinentry with <code>pkill gpg-agent ; pkill ssh-agent ; pkill pinentry ; eval $(gpg-agent --daemon --enable-ssh-support)</code>, then plug in the other key and run <code>gpg-connect-agent updatestartuptty /bye</code> - then it should be ready for use.</li>
</ol>
<h1 id="troubleshooting">Troubleshooting</h1>
<ul>
<li>
<p>Use <code>man gpg</code> to understand GPG options and command-line flags.</p>
</li>
<li>
<p>If you encounter problems connecting to YubiKey with GPG - try unplugging and re-inserting YubiKey, and restarting the <code>gpg-agent</code> process.</p>
</li>
<li>
<p>If you receive the error, <code>gpg: decryption failed: secret key not available</code> - you likely need to install GnuPG version 2.x.</p>
</li>
<li>
<p>If you receive the error, <code>Yubikey core error: no yubikey present</code> - make sure the YubiKey is inserted correctly. It should blink once when plugged in.</p>
</li>
<li>
<p>If you still receive the error, <code>Yubikey core error: no yubikey present</code> - you likely need to install newer versions of yubikey-personalize as outlined in <a href="#required-software">Required software</a>.</p>
</li>
<li>
<p>If you receive the error, <code>Yubikey core error: write error</code> - YubiKey is likely locked. Install and run yubikey-personalization-gui to unlock it.</p>
</li>
<li>
<p>If you receive the error, <code>Key does not match the card's capability</code> - you likely need to use 2048 bit RSA key sizes.</p>
</li>
<li>
<p>If you receive the error, <code>sign_and_send_pubkey: signing failed: agent refused operation</code> - make sure you replaced <code>ssh-agent</code> with <code>gpg-agent</code> as noted above.</p>
</li>
<li>
<p>If you still receive the error, <code>sign_and_send_pubkey: signing failed: agent refused operation</code> - <a href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=835394">run the command</a> <code>gpg-connect-agent updatestartuptty /bye</code></p>
</li>
<li>
<p>If you still receive the error, <code>sign_and_send_pubkey: signing failed: agent refused operation</code> - edit <code>~/.gnupg/gpg-agent.conf</code> to set a valid <code>pinentry</code> program path, e.g. <code>pinentry-program /usr/local/bin/pinentry-mac</code> on macOS.</p>
</li>
<li>
<p>If you receive the error, <code>The agent has no identities</code> from <code>ssh-add -L</code>, make sure you have installed and started <code>scdaemon</code>.</p>
</li>
<li>
<p>If you receive the error, <code>Error connecting to agent: No such file or directory</code> from <code>ssh-add -L</code>, the UNIX file socket that the agent uses for communication with other processes may not be set up correctly. On Debian, try <code>export SSH_AUTH_SOCK=&quot;/run/user/$UID/gnupg/S.gpg-agent.ssh&quot;</code>. Also see that <code>gpgconf --list-dirs agent-ssh-socket</code> is returning single path, to existing <code>S.gpg-agent.ssh</code> socket.</p>
</li>
<li>
<p>If you receive the error, <code>Permission denied (publickey)</code>, increase ssh verbosity with the <code>-v</code> flag and ensure the public key from the card is being offered: <code>Offering public key: RSA SHA256:abcdefg... cardno:00060123456</code>. If it is, ensure you are connecting as the right user on the target system, rather than as the user on the local system. Otherwise, be sure <code>IdentitiesOnly</code> is not <a href="https://github.com/FiloSottile/whosthere#how-do-i-stop-it">enabled</a> for this host.</p>
</li>
<li>
<p>If SSH authentication still fails - add up to 3 <code>-v</code> flags to the <code>ssh</code> client to increase verbosity.</p>
</li>
<li>
<p>If it still fails, it may be useful to stop the background <code>sshd</code> daemon process service on the server (e.g. using <code>sudo systemctl stop sshd</code>) and instead start it in the foreground with extensive debugging output, using <code>/usr/sbin/sshd -eddd</code>. Note that the server will not fork and will only process one connection, therefore has to be re-started after every <code>ssh</code> test.</p>
</li>
</ul>
<h1 id="links">Links</h1>
<ul>
<li><a href="https://alexcabal.com/creating-the-perfect-gpg-keypair/">https://alexcabal.com/creating-the-perfect-gpg-keypair/</a></li>
<li><a href="https://blog.habets.se/2013/02/GPG-and-SSH-with-Yubikey-NEO">https://blog.habets.se/2013/02/GPG-and-SSH-with-Yubikey-NEO</a></li>
<li><a href="https://blog.josefsson.org/2014/06/23/offline-gnupg-master-key-and-subkeys-on-yubikey-neo-smartcard/">https://blog.josefsson.org/2014/06/23/offline-gnupg-master-key-and-subkeys-on-yubikey-neo-smartcard/</a></li>
<li><a href="https://blog.onefellow.com/post/180065697833/yubikey-forwarding-ssh-keys">https://blog.onefellow.com/post/180065697833/yubikey-forwarding-ssh-keys</a></li>
<li><a href="https://developers.yubico.com/PGP/Card_edit.html">https://developers.yubico.com/PGP/Card_edit.html</a></li>
<li><a href="https://developers.yubico.com/PIV/Introduction/Admin_access.html">https://developers.yubico.com/PIV/Introduction/Admin_access.html</a></li>
<li><a href="https://developers.yubico.com/yubico-piv-tool/YubiKey_PIV_introduction.html">https://developers.yubico.com/yubico-piv-tool/YubiKey_PIV_introduction.html</a></li>
<li><a href="https://developers.yubico.com/yubikey-personalization/">https://developers.yubico.com/yubikey-personalization/</a></li>
<li><a href="https://developers.yubico.com/yubikey-piv-manager/PIN_and_Management_Key.html">https://developers.yubico.com/yubikey-piv-manager/PIN_and_Management_Key.html</a></li>
<li><a href="https://evilmartians.com/chronicles/stick-with-security-yubikey-ssh-gnupg-macos">https://evilmartians.com/chronicles/stick-with-security-yubikey-ssh-gnupg-macos</a></li>
<li><a href="https://gist.github.com/ageis/14adc308087859e199912b4c79c4aaa4">https://gist.github.com/ageis/14adc308087859e199912b4c79c4aaa4</a></li>
<li><a href="https://github.com/herlo/ssh-gpg-smartcard-config">https://github.com/herlo/ssh-gpg-smartcard-config</a></li>
<li><a href="https://github.com/tomlowenthal/documentation/blob/master/gpg/smartcard-keygen.md">https://github.com/tomlowenthal/documentation/blob/master/gpg/smartcard-keygen.md</a></li>
<li><a href="https://help.riseup.net/en/security/message-security/openpgp/best-practices">https://help.riseup.net/en/security/message-security/openpgp/best-practices</a></li>
<li><a href="https://jclement.ca/articles/2015/gpg-smartcard/">https://jclement.ca/articles/2015/gpg-smartcard/</a></li>
<li><a href="https://rnorth.org/gpg-and-ssh-with-yubikey-for-mac">https://rnorth.org/gpg-and-ssh-with-yubikey-for-mac</a></li>
<li><a href="https://trmm.net/Yubikey">https://trmm.net/Yubikey</a></li>
<li><a href="https://www.bootc.net/archives/2013/06/09/my-perfect-gnupg-ssh-agent-setup/">https://www.bootc.net/archives/2013/06/09/my-perfect-gnupg-ssh-agent-setup/</a></li>
<li><a href="https://www.esev.com/blog/post/2015-01-pgp-ssh-key-on-yubikey-neo/">https://www.esev.com/blog/post/2015-01-pgp-ssh-key-on-yubikey-neo/</a></li>
<li><a href="https://www.hanselman.com/blog/HowToSetupSignedGitCommitsWithAYubiKeyNEOAndGPGAndKeybaseOnWindows.aspx">https://www.hanselman.com/blog/HowToSetupSignedGitCommitsWithAYubiKeyNEOAndGPGAndKeybaseOnWindows.aspx</a></li>
<li><a href="https://www.void.gr/kargig/blog/2013/12/02/creating-a-new-gpg-key-with-subkeys/">https://www.void.gr/kargig/blog/2013/12/02/creating-a-new-gpg-key-with-subkeys/</a></li>
<li><a href="https://mlohr.com/gpg-agent-forwarding/">https://mlohr.com/gpg-agent-forwarding/</a></li>
</ul>

        </span>
    </article>
</section>


      </div>

      <footer class="footer">
  <section class="container">
    
        
        <a href="/quotes"><p>Things will not calm down, as a matter of fact they will just calm up - Teal'c (Stargate)</p></a>
        
    
  </section>
</footer>

    </main>

    

    
    <script type="text/javascript" src="/jquery/jquery-1.11.3.min.js"></script>
    <script type="text/javascript" src="/jquery/jquery.typedjs-2.0.11.min.js"></script>
    
    <script type="text/javascript" src="/scripts/coder.js"></script>


  </body>

</html>
